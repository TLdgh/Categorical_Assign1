---
title: "MAT5317 Categorical Assignment 1"
author:
- Teng Li(7373086)
- Zhize Lu(300075114)
- Chutong Zhang(300311325)
output: bookdown::html_document2
header-includes:
- \renewcommand{\and}{\\}
- \usepackage{float}
- \floatplacement{figure}{H}
bibliography: References.bib
link-citations: yes
---

<style type="text/css">
.title, .author{text-align: center;}
body{font-size: 12pt;}
table{font-size: 12pt;}
h1{font-size: 14pt;}
h2{font-size: 12pt;}
</style>

```{r setup, echo=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
library(plotly)
library(tidyverse)
library(kableExtra)
library(aplore3)
library(table1)
source("CodeSpace.R")
```

# Introduction

We were given the data set of The National Health and Nutrition Examination Survey (NHANES). The  NHANES III data set from 2009-2010 is an ongoing and continuous series of surveys focused on civilian non-institutional population fo the United states and published by CDC every year. It is designed to be a surveillance of specific diseases and behaviors, providing statistical insights into the U.S population.[@SurveyDesign]. The survey program assesses the health and nutritional status of adults and children in the United States since the 1960s, combining in-person face-to-face interviews and physical examinations of participants for data collection according to CDC [@CDC]. 

The survey data wasn't a simple random sample, however. According to CDC's National Health and Nutrition Examination Survey: Plan and Operations, 1999--2010 [@SurveyDesign], the sampling strategy consists of several stages: 1. Selection of counties as primary sampling units (PSU). 2. selection of segments within PSUs that constitute blocks of households. 3. Selection of specific households within segments. 4. Selection of individuals within a household.

In this assignment, we accessed the data set from the aplore3 package in R, which contains 6482 observations in 21 variables. Eight of these variables (gender, marstat, vigwrk, modwrk, wlkbik, vigrecexr, and obesity) are considered as categorical variables, while the rest are numerical variables. We aim to study the relationship between the weight variable and the other health related variables of the data.

# Method

The weight variable was a continuous random variable in our data. A simple way of categorizing it was to consider the BMI indicator. While there are other indicators like waist circumference and waist-to-height ratio for better measurement of human health conditions [@CompareBMI], we didn't have these data available in the package, therefore we categorized the weight by BMI levels. The nhanes data from the package came with the indicator "obese" showing if the participant was obese or not by considering BMI level greater than a threshold of 35, thus resulted in the obese variable as the binary random variable. However, a slightly better way to categorizing the weight was introduced by CDC's guideline [@BMICDC]. According to CDC's classification on body weight, we have: BMI $\leq$ 18.5 as Underweight, BMI between 18.5 and 24.9 as Health, BMI between 25 and 29.9 as Overweight, and BMI $\geq$ 30 as obesity. In our assignment we will explore both ways of categorizing the weight to properly fit in our analysis.

We began our study by doing an exploratory analysis among the variables through various tables and charts. We then performed several hypothesis tests to find the relationship between the weight variable and other variables.

# Analysis

We first of all gave Table 1 below to illustrate the overall appearance of the variables given the weight being categorized under CDC's approach. For categorical variables, the first three columns presented the total number of observation and percentage for different levels of BMI, and the last column was the sum of the first three columns and the percentage of the total observations. For numerical variables, the first three columns were the mean and standard deviation under the stratification condition and the last column was the mean and standard deviation under overall level. The rows showed the variable name with its subcategories. If the variable had missing values, there was an additional row showing the statistic. In the original data set, it existed 6482 observations and 37 were missing for the variable bmi. Due to small size of the missing data less than 0.6% in total, We omited these missing data for bmi and only considered 6445 observations as total sample size. However, as one can see that some variables had a high percentage of overall missing values. the highest being Marital Status as 9.7%. This high percentage of missing value could affect one's analysis, for example in a linear regression model estimating the relationships between the weight and others. One could question if the marital status really had any influence on the body weight.

We had several numerical variables for which we wanted to explain, namely the cholesterol levels and the blood pressure. Cholesterol is a type of lipid that helps body perform important body functions. The variable "tchol" indicated the Total Cholesterol, the total amount of cholesterol circulated in people's blood. The variable "hdl" indicated the HDL-Cholesterol, which is the high-density lipoprotein cholesterol that helps people transfer excess cholesterol from the blood to the liver [@CHOL]. "sysbp" standed for Systolic Blood Pressure and "dbp" stands for Diastolic Blood Pressure. "Systolic pressure represents the maximum blood pressure when ventricles contract while diastolic pressure denotes the minimum blood pressure registered just before the subsequent contraction [@BP]. We discussed the thresholds for cholesterol and blood pressure in the following discussion. Two other numerical variables in this data set were worth noticing, psu and strata. They were the Pseudo-PSU and Pseudo-stratum used in sampling strategy. In this data set, stratum was defined by geography and psu were selected from every stratum with probability proportional to a measure of size(PPS). More details about survey weights for NHANES will be presented in the extra topic section.

We also had several categorical variables. One can find the work or recreational activities, each corresponding to the levels of intensity being vigorous and moderate. Level of vigorous was defined by the experimental design such that the intense physical exertion leading to significant elevation in respiration and heart rate. It usually sustained for more than 10 minutes during the work or recreational activities. Moderate work and recreational activities were defined such that activities require moderate physical effort and results in slight increase in respiration and heart rate, which usually sustained for less than 10 minutes during the work or recreational activities.[@CODE] 

```{r}
#Table 1 
Bnhanes<-nhanes
Bnhanes<-mutate(Bnhanes,BMI_level = case_when(
  Bnhanes$bmi < 18.5 ~"Underweight",
  Bnhanes$bmi < 25 ~"Healthy weight",
  Bnhanes$bmi < 30 ~"Overweight",
  Bnhanes$bmi >= 30 ~"Obesity "))%>%
  filter(!is.na(Bnhanes$bmi))

label(Bnhanes$gender) <- "Gender"
label(Bnhanes$age)<-"Age"
label(Bnhanes$marstat)<-"Marital Status"
label(Bnhanes$samplewt)<-"Statistical Weight"
label(Bnhanes$psu)<-"Pseudo-PSU"
label(Bnhanes$strata)<-"Pseudo-stratum"
label(Bnhanes$tchol)<-"Total Cholesterol"
label(Bnhanes$hdl)<-"HDL-Cholesterol"
label(Bnhanes$sysbp)<-"Systolic Blood Pressure"
label(Bnhanes$dbp)<-"Diastolic Blood Pressure "
label(Bnhanes$wt)<-"Weight"
label(Bnhanes$ht)<-"Standing Height"
label(Bnhanes$bmi)<-"Body mass Index"
label(Bnhanes$vigwrk)<-"Vigorous Work Activity"
label(Bnhanes$modwrk)<-"Moderate Work Activity "
label(Bnhanes$wlkbik)<-"Walk or Bicycle "
label(Bnhanes$vigrecexr)<-"Vigorous Recreational Activities "
label(Bnhanes$modrecexr)<-"Moderate Recreational Activities"
label(Bnhanes$sedmin)<-"Minutes of Sedentary Activity per Week "
label(Bnhanes$obese)<-"Obese "

units(Bnhanes$age) <- "years"
units(Bnhanes$tchol) <- "mg/dL"
units(Bnhanes$hdl) <- "mg/dL"
units(Bnhanes$sysbp) <- "mm Hg"
units(Bnhanes$dbp) <- "mm Hg"
units(Bnhanes$wt) <- "Kg"
units(Bnhanes$ht) <- "cm"
units(Bnhanes$bmi) <- "Kg/m^2"
units(Bnhanes$sedmin) <- "mins"

my.render.cont <- function(x) {
  with(stats.apply.rounding(stats.default(x), digits=3), c("",
                                                           "Mean (SD)"=sprintf("%s (Â± %s)", MEAN, SD)))
}

tbl<-table1 (~ gender+age+marstat+samplewt+psu+strata+tchol+hdl+sysbp+dbp+wt+ht+vigwrk+modwrk+wlkbik+vigrecexr+modrecexr+sedmin+obese |BMI_level,render.continuous=my.render.cont, data=Bnhanes)
kable(tbl,"html",caption="Characteristics of the data set NHANES")%>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

## Age and Gender

We first began our analysis on the relationship between the weight variable with the Age and Gender variables. This data set mainly focused on the observers between 16 to 80 years old. Among them, the average weight for male was greater than female among all ages, and as we can see from the line chart that the change in average weight with age followed the same trend across the gender, with a general tendency to sustained increase, followed by fluctuation and continuous decrease finally. One can conclude that there might existed some relationship between weight and age.

```{r, fig.cap="Average Weight in Different Age"}
#exploratory average weight in every age grouped by gender
gender<-nhanes%>%
  group_by(gender,age)%>%
  summarise(Avgwt=mean(wt,na.rm=TRUE), .groups="drop")
ggplot(gender,aes(x=age, y=Avgwt), group=gender)+
  geom_point(aes(colour=gender),size=1 )+
  geom_line(aes(fill=gender,colour=gender,linetype=gender) )+
  geom_hline(yintercept = 86.2, linetype="dotted", size = 0.5)+
  geom_hline(yintercept = 74.9, linetype="dotted", size = 0.5)+
  annotate("text", y=86.2, x=18, label=" Male Avg.")+
  annotate("text", y=74.9, x=18, label="Female Avg.")+
  scale_y_continuous( labels = scales::comma  ) +
  theme(axis.text.x = element_text(size =7, vjust = 0.5, hjust = 0.5, angle = 45))+
  
  labs(x="Age", y="Average weight (Kg)")+
  theme(plot.title = element_text(hjust = 0.5))
```

In order to find the relationship between weight and gender or age , we first categorized the numerical variables. As mentioned in Table 1, we use the BMI level defined by CDC for categorize the weight in the following analysis. For age, we divided it into three groups based on NIH recommendations: younger than 18 for adolescents, 18 to 65 for adults, and older than 65 for older adults. Then we created the contingency tables for variables and used pearson GOF chi-square test and likelihood ratio test to testing independence and discussing difference from these test methods.

```{r}
# Categorize age 
Catenhanes<-nhanes%>%
  mutate(agegroup=case_when(
    age<18~"Adolescents",
    age<65~"Adults",
    age>=65~"Older Adults"),
    BMI_level=case_when(
      bmi <18.5 ~ "Underweight", 
      bmi>=18.5 & bmi<=24.9 ~ "Healthy",
      bmi>24.9 & bmi<=29.9 ~ "Overweight",
      bmi>29.9  ~ "Obesity")
  )%>%
  filter(!is.na(bmi))
Catenhanes$agegroup<-factor(Catenhanes$agegroup,levels=c("Adolescents","Adults","Older Adults"),labels=c("Adolescents","Adults","Older Adults"))
Catenhanes$BMI_level<-factor(Catenhanes$BMI_level,levels=c("Underweight", "Healthy","Overweight","Obesity" ),labels=c("Underweight", "Healthy","Overweight","Obesity"))

#contingency table: BMI vs agegroup
testBA<-IndepTest$new(Catenhanes, "BMI_level", "agegroup")
tableBA<-testBA$ContingencyTbl$BMI_level%>%
  rename("\t" =BMI_level) %>%
  add_column(" " = c("BMI level", rep(" ", nrow(.) - 1)), .before = "\t") %>%
  kable(caption = "Contingency Table for BMI and Agegroup")%>%
  kable_styling(bootstrap_options=c("striped","condensed"),full_width = F,position="float_left")%>%
  add_header_above(c(" " = 1, " " = 1, "Agegroup" = 3))%>%
  column_spec(1:2,width = "6em",bold=TRUE)
tableBA
```

```{r}
#contingency table: BMI vs Gender
testBG<-IndepTest$new(Catenhanes, "BMI_level", "gender")
tableBG<-testBG$ContingencyTbl$BMI_level%>%
  rename("\t" =BMI_level) %>%
  add_column(" " = c("BMI level", rep(" ", nrow(.) - 1)), .before = "\t") %>%
  kable(caption = "Contingency Table for BMI and Gender")%>%
  kable_styling(bootstrap_options=c("striped","condensed"),full_width = F,position="left")%>%
  add_header_above(c(" " = 1, " " = 1, "Gender" = 2))%>%
  column_spec(1:2,width = "8em",bold=TRUE)
tableBG 
```

```{r}

#likelihood ratio test (age)
ba<-Catenhanes%>%
  group_by(BMI_level,agegroup)%>%
  summarise(count=n(),.groups="drop")
BA<-matrix(ba$count,nrow=3,ncol=4)
totalcol=c((17+86+21),(188+1322+343),(74+1536+518),(63+1765+512))
totalrow=c((17+188+74+63),(86+1322+1536+1765),(21+343+518+512),sum(BA))
BAT<-rbind(BA,totalcol)
BAT<-cbind(BAT,totalrow)
rownames(BAT)=c("Adolescents","Adults","Older Adults","Total")
colnames(BAT)=c("Underweight", "Healthy","Overweight","Obesity","Total")
propBAT<-round(BAT/6445,4)

P_i<-matrix(propBAT[,5])
P_j<-matrix(propBAT[4,])
Exp<-round((P_i%*%t(P_j))*6445,4)
ExpBA<-as.data.frame(Exp[1:3,1:4])
ObsBA<-as.data.frame(BA)
G_value=2*sum(ObsBA*log(ObsBA/ExpBA))
PA=format(pchisq(G_value, df=6, lower.tail=FALSE), digits = 4)

#likelihood ratio test (gender)
bg<-Catenhanes%>%
  group_by(BMI_level,gender)%>%
  summarise(count=n(),.groups="drop")
BG<-matrix(bg$count,nrow=2,ncol=4)
totalcol=c((40+84),(884+969),(1168+960),(1052+1288))
totalrow=c((40+884+1168+1052),(84+969+960+1288),sum(BG))
BGT<-rbind(BG,totalcol)
BGT<-cbind(BGT,totalrow)
rownames(BGT)=c("Male","Female","Total")
colnames(BGT)=c("Underweight", "Healthy","Overweight","Obesity","Total")
propBGT<-round(BGT/6445,4)

p_i<-matrix(propBGT[,5])
p_j<-matrix(propBGT[3,])
exp<-round((p_i%*%t(p_j))*6445,4)
ExpBG<-as.data.frame(exp[1:2,1:4])
ObsBG<-as.data.frame(BG)
G_value=2*sum(ObsBG*log(ObsBG/ExpBG))
PG=format(pchisq(G_value, df=3, lower.tail=FALSE), digits = 4)
```

```{r}
#Chi-square table
ptbl<-data.frame(testBA$pval_df, testBG$pval_df)
colnames(ptbl)<-c("Weight VS Age ", "Weight VS.Gender")
ptbl%>%
  kable(caption = "Chi-square test p-values of Independence Tests between Variables") %>%
  kable_styling(bootstrap_options = c("striped", "condensed"),full_width = F,position = "float_left")
```

```{r}
#LRT table
PA=as.character(PA)
PG=as.character(PG)
ltbl<-data.frame(PA,PG)
colnames(ltbl)<-c("Weight VS Age ", "Weight VS.Gender")
rownames(ltbl)<-"p-value"
ltbl%>%
  kable(caption = "Likelihood ratio test p-values of Independence Tests between Variables") %>%
  kable_styling(bootstrap_options = c("striped", "condensed"),full_width = F,position = "float_left")

```

We observed that under the Chi-squared test, the p-valve for weight and age was $2.543\times10^{-32}$ and the p-value for weight and gender was $6.311\times10^{-13}$.The p-values from likelihood ratio test were slightly different with $1.976\times10^{-29}$ for weight and age, $5.223\times10^{-13}$ for weight and gender. Both two methods had the p-value much less than 0.001, hence indicated that we could reject the null hypothesis and concluded there existed relationship between weight and age, and weight and gender. One can further test that there is a linear relationship between the weight and age given gender by fitting a linear model. Because of the presence of the trend, one might do three linear models on three categories of the age variable, or one might consider a polynomial regression model for the weight response and the overall age predictor, which would not be further discussed in this assignment.

## Marital Status

We then analyzed the relationship between weight and marital status. The following box plot shows that the median weight under different marital status are all around 80 Kg,  except widowed observations having lowest weight among the six categories. Married and Never Married observations had more people heavier than 130 Kg than other categories, however all the outliers above 140 kilograms were rather similar, therefore from this boxplot we could not really see a difference of the weight distribution among categories of marital status. 

```{r, fig.cap="Boxplot of Weight for Different Marital Status"}
#box plot for weight VS marital status
Nhanes<-nhanes%>%
  na.omit()
ggplot(Nhanes, aes(x=marstat, y=wt, fill=marstat))+
  geom_boxplot() + 
  scale_fill_brewer(palette="Blues") +
  labs(x="Marital Status", y="Weight (Kg)")+
  theme(axis.text.x = element_text(size =7, vjust = 0.5, hjust = 0.5, angle = 45),
        plot.title = element_text(hjust = 0.5)
  )
```

This prompt us to question if there was really a relationship between the variables, so we tested the independence using the Chi-squared test. For simplicity we considered categorizing the weight to a binary "obese" random variable by defining obesity as BMI level $\geq 35$, as given in the data set. We formed the contingency table Table 3.6.

```{r}
test_marstat<-IndepTest$new(nhanes, "marstat", "obese")
test_marstat$ContingencyTbl$marstat%>%
  rename("\t" = marstat) %>%
  add_column(" " = c("Marital Status", rep(" ", nrow(.) - 1)), .before = "\t") %>%
  kable(caption = "Contingency Table")%>%
  kable_styling(bootstrap_options=c("striped","condensed"),position="float_left")%>%
  add_header_above(c(" " = 1, " " = 1, "Obesity" = 2))%>%
  column_spec(1:2,width = "10em",bold=TRUE)
```
```{r}
test_marstat$pval_df%>%
  kable(caption = "pvalues for Chi-squared Independence Test")%>%
  kable_styling(bootstrap_options=c("striped","condensed"),full_width=F,position="float_left")%>%
  column_spec(2,width = "15em",bold=TRUE)
```

Let X be the categorical random variable for Marital Status and Y be the one for Obesity. Assuming a random sample of n trials. Define the count random variable $N_{ij}:=\sum_{k=1}^n \mathbf{I}_k(X=i, Y=j)$ where $\mathbf{I}_k$ is the indicator function for the k-th trial, then the joint random variables $[N_{11}, ..., N_{IJ}]$ has a Multinomial distribution $\vec{p}=[p_{11}, ..., p_{IJ}]$. Our hypothesis test is therefore:

```{=tex}
\begin{gather*}
H_0: p_{ij}= p_{i+} \cdot p_{+j} ~ \forall i,j\\
H_1:p_{ij} \neq p_{i+} \cdot p_{+j} ~ \forall i,j
\end{gather*}
```

From the p-value being equal to 0.6894,we concluded that there was not enough evidence to reject the null hypothesis. In other words, we could not conclude that there was a relationship between obesity and marital status, hence supporting our initial guess in the boxplot analysis.

## Cholesterol and Blood Pressure

Cholesterol is an essential fat in the body. We first gave a exploratory analysis on the relationship between the weight and the cholesterol variables. We adopted CDC's category for weight and plotted the mean levels of total cholesterol and HDL cholesterol in Figure 3.5. We found that there was a slight positive relationship between body weight and the total cholesterol level and noticed that there was a negative relationship between the HDL and body weight. Because of the fact that Total cholesterol level is the sum of HDL and LDL level, we can conclude that the obese population has a high level of LDL and a low level HDL. Our analysis was inline with a more recent study on the effect of BMI on lipid profile in children and adolescents in Saudi Arabia [@Saudi]. In this study the researchers concluded that "High BMI was found to be associated with increased levels of LDL cholesterol and decreased levels of HDL cholesterol. No significant association between gender and changes in lipid profile was established (P = 0.898)".

```{r, fig.cap="Mean Cholesterol level across Categories of Body Weight"}
nhanes%>%mutate(CDC_obese=case_when(
  bmi <18.5 ~ "Underweight", 
  bmi>=18.5 & bmi<=24.9 ~ "Healthy",
  bmi>24.9 & bmi<=29.9 ~ "Overweight",
  bmi>29.9  ~ "Obesity"
))%>%transmute(CDC_obese=factor(CDC_obese, levels=c("Underweight", "Healthy", "Overweight", "Obesity")), tchol, hdl)%>%na.omit()%>% group_by(CDC_obese)%>%summarise(Mean_tchol=mean(tchol), Mean_hdl=mean(hdl))%>%gather("Type", "Value",Mean_tchol:Mean_hdl)%>%
  plot_ly(x=~CDC_obese, y=~Value, color = ~Type, type = "scatter", mode="lines", height = 300,width = 800)%>%
  layout(
    yaxis = list(range = c(45, 200),dtick = 50)
  )
```

We then categorized the cholesterol and blood pressure level into different levels. According to American Heart Association ATPIII [@ATP], We have: tchol $\geq$ 240mg/dl OR hdl $<$ 40mg/dL as Dangerous Cholesterol level; tchol between 200-239mg/dL OR hdl between 40-59mg/dL for males (50-59mg/dL for females) as At Risk level; tchol $<$ 200mg/dL and hdl $\geq$ 60mg/dL as Healthy level.

Blood pressure is typically categorized into different stages based on the systolic (top number) and diastolic (bottom number) readings. According to American Heart Association [@BloodP], We have: systolic level $<$ 120mm Hg and diastolic level $<$ 80mm Hg as normal blood pressure; systolic level between 120-129mm Hg and diastolic level $<$ 80mm Hg as elevated blood pressure; systolic level between 130-139mm Hg OR diastolic level between 80-89mm Hg as Hypertension Stage 1; systolic level $\geq$ 140mm Hg OR diastolic level $\geq$ 90mm Hg as Hypertension Stage 2; systolic level $>$ 180mm Hg OR diastolic level $>$ 120mm Hg as Hypertensive Crisis.

```{r}
#Categorization
nhanes_data <- nhanes

nhanes_data <- nhanes_data[complete.cases(nhanes_data[, c("bmi", "gender", "tchol", "hdl", "sysbp", "dbp")]), ]

# Categorize body weight based on BMI
nhanes_data$weight_category <- with(nhanes_data, ifelse(
  bmi < 18.5, "Underweight",
  ifelse(bmi >= 18.5 & bmi <= 24.9, "Healthy",
         ifelse(bmi >= 25 & bmi <= 29.9, "Overweight", "Obese"))))

# Categorizing cholesterol levels
nhanes_data$chol_category <- with(nhanes_data, ifelse(
  tchol >= 240 | hdl < 40, "Dangerous",
  ifelse(
    tchol >= 200 & tchol < 240 | 
      (gender == "Male" & hdl >= 40 & hdl < 60) |  # Male and HDL between 40-59
      (gender == "Female" & hdl >= 50 & hdl < 60),   # Female and HDL between 50-59
    "At Risk",
    "Healthy"
  )
))

# Preview
#head(nhanes_data[, c("gender","tchol", "hdl", "chol_category")])

# Categorizing blood pressure
nhanes_data$bp_category <- with(nhanes_data, ifelse(
  sysbp < 120 & dbp < 80, "Normal",
  ifelse(sysbp >= 120 & sysbp <= 129 & dbp < 80, "Elevated",
         ifelse(sysbp > 180 | dbp > 120, "Hypertensive Crisis",
                ifelse(sysbp >= 140 | dbp >= 90, "Hypertension Stage 2",
                       ifelse((sysbp >= 130 & sysbp <= 139) | (dbp >= 80 & dbp <= 89), "Hypertension Stage 1", NA))))))

# Preview
#head(nhanes_data[, c("sysbp", "dbp", "bp_category")])
```

After categorizing Cholesterol level and blood pressure, we create three contingency tables in Table 3.8, Table 3.9 and Table 3.10 below.

```{r}
test1 <- IndepTest$new(nhanes_data, "weight_category", "chol_category")
test2 <- IndepTest$new(nhanes_data, "weight_category", "bp_category")
test3 <- IndepTest$new(nhanes_data, "chol_category", "bp_category")

#contingency table for Weight vs. Cholesterol
table_weight_chol <- test1$ContingencyTbl$weight_category %>%
  rename("\t" = weight_category) %>%
  add_column(" " = c("Weight", rep(" ", nrow(.) - 1)), .before = "\t") %>%
  kable(caption = "Contingency Table: Weight vs. Cholesterol") %>%
  kable_styling(bootstrap_options = c("striped", "condensed"), position = "float_left") %>%
  add_header_above(c(" " = 1, " " = 1, "Cholesterol" = 3)) %>%
  column_spec(1:2, width = "10em", bold = TRUE)
table_weight_chol
```

```{r}
#contingency table for Weight vs. Blood Pressure
table_weight_bp <- test2$ContingencyTbl$weight_category %>%
  rename("\t" = weight_category) %>%
  add_column(" " = c("Weight", rep(" ", nrow(.) - 1)), .before = "\t") %>%
  kable(caption = "Contingency Table: Weight vs. Blood Pressure") %>%
  kable_styling(bootstrap_options = c("striped", "condensed"), position = "float_left") %>%
  add_header_above(c(" " = 1, " " = 1, "Blood Pressure" = 5)) %>%
  column_spec(1:2, width = "10em", bold = TRUE)
table_weight_bp
```

```{r}
#contingency table for Cholesterol vs. Blood Pressure
table_chol_bp <- test3$ContingencyTbl$chol_category %>%
  rename("\t" = chol_category) %>%
  add_column(" " = c("Cholesterol", rep(" ", nrow(.) - 1)), .before = "\t") %>%
  kable(caption = "Contingency Table: Cholesterol vs. Blood Pressure") %>%
  kable_styling(bootstrap_options = c("striped", "condensed"), position = "float_left") %>%
  add_header_above(c(" " = 1, " " = 1, "Blood Pressure" = 5)) %>%
  column_spec(1:2, width = "10em", bold = TRUE)
table_chol_bp
```

```{r}
pvals<-data.frame(test1$pval_df, test2$pval_df, test3$pval_df)
colnames(pvals)<-c("Weight VS Cholesterol", "Weight VS. Blood Pressure", "Cholesterol VS. Blood Pressure")

pvals%>%kable(caption = "p-values of Independence Tests between Variables") %>%
  kable_styling(bootstrap_options = c("striped", "condensed"), position = "float_left")
```

We again conducted hypothesis testing using Pearson chi-squared test. From Table 3.11 we could see that the p-value for weight and cholesterol is extremely small, equals to $1.475\times10^{-53}$. This suggested that there was a statistically significant association between weight and cholesterol levels. For weight against blood pressure, the p-value was $5.723\times10^{-35}$ which indicates that between weight and blood pressure, there was significant relationship. Cholesterol level was also associated with blood pressure with a p-value equals to $3.286\times10^{-13}$.

However, there are potential confounding variables like diet, therefore for further study one needs to collect the data and conduct a stratified analysis. 

Overall, the results suggested that there was a significant association between weight, cholesterol, and blood pressure. The patterns observed in the contingency tables align with general health knowledge: obesity is a risk factor for both high cholesterol and high blood pressure. 

## Activities

We then want to analyze the relationship between body weight and human activities. The two types of activity measurements were given in the data, the work activity and the recreational activity, each given at intensity levels of vigorous and moderate. 

```{r} 
#boxplot for Vigorous activities VS bmi
Nhanes1<-nhanes%>%select(bmi, vigwrk, vigrecexr)%>%na.omit()%>%
  mutate(vigrecexr=factor(vigrecexr, levels = c("Yes", "No"), labels = c("VigR=Yes", "VigR=No")))%>%
  mutate(RecGivenWrk=factor(paste0(vigrecexr,"|", "VigW=", vigwrk)))

#boxplot for Moderate activities VS bmi
Nhanes2<-nhanes%>%select(bmi, modwrk, modrecexr)%>%na.omit()%>%
  mutate(modrecexr=factor(modrecexr, levels = c("Yes", "No"), labels = c("ModR=Yes", "ModR=No")))%>%
  mutate(RecGivenWrk=factor(paste0(modrecexr,"|", "ModW=", modwrk)))

p1<-ggplot(Nhanes1, aes(x=RecGivenWrk, y=bmi, fill=vigwrk))+
  geom_boxplot() +
  geom_hline(yintercept = 18.5, linetype="dotted", size = 0.5)+
  geom_hline(yintercept = 30, linetype="dotted", size = 0.5)+
  annotate("text", y=17, x=" ", label=" underweight")+
  annotate("text", y=31, x=" ", label=" obsity")+
  theme(axis.text.x = element_text(size =7, vjust = 0.5, hjust = 0.5, angle = 45))
p1<-ggplotly(p1)

p2<-ggplot(Nhanes2, aes(x=RecGivenWrk, y=bmi, fill=modwrk))+
  geom_boxplot() + 
  geom_hline(yintercept = 18.5, linetype="dotted", size = 0.5)+
  geom_hline(yintercept = 30, linetype="dotted", size = 0.5)+
  annotate("text", y=17, x=" ", label=" underweight")+
  annotate("text", y=31, x=" ", label=" obsity")+
  labs(x="Moderate Recreational Activity given Work Activity", y="BMI")+
  theme(axis.text.x = element_text(size =7, vjust = 0.5, hjust = 0.5, angle = 45))
p2<-ggplotly(p2)
```

```{r, fig.cap="Boxplot of BMI for Different Recreational Activity Conditional on Work Activity"}
subplot(p1,p2,shareY = TRUE)%>%
  layout(
    width=900,
    margin=list(l=0, r=0, b=0, t=20),
    xaxis=list(title=list(text="Vigorous Recreational Activity | Vigorous Work Activity", font=list(size=11))),
    xaxis2=list(title=list(text="Moderate Recreational Activity | Moderate Work Activity", font=list(size=11))),
    yaxis=list(title="BMI"))
```

From the left plot of Figure 3.4 above one can see that the vigorous recreational activities yield BMI observations between the healthy range of 18.5 to 30, regardless of the condition on work activities. However, the non-vigorous recreational activities yield systemically higher levels of BMI than that of the vigorous recreational activities, again regardless of the condition on work activities. From the right-hand side plot we observed the same pattern when considering moderate intensity of work and recreational activities. If one do a vertical comparison between the intensity of activities, one could see that there was no significant difference except that vigorous recreational activities had the 25% to 75% quantile range of BMI a little closer to the healthy interval defined by CDC than moderate recreational activities did. Assuming the risk $p$ is defined as the probability of having a BMI NOT inside the range of 18.5 to 30, i.e. either being underweight or obesity. We defined $p_{VigR=Y}$ as the risk for the participants with vigorous recreational activities, and $p_{VigR=N}$ is the risk for those with no vigorous recreational activities. We therefore defined a binary random variable called "InRange" to indicate that if the body weight is within the healthy range. We proposed the following two statements:

1. $p_{VigR=Y} < p_{VigR=N}$, perhaps independent of Work Activities

2. Intensity of recreational activities also plays a role in getting healthy weight

To support our first statement, we first did the independence test for all activity-related variables with obesity. Based on the pvalues shown in Table 3.12, we rejected the independence between InRange and wlkbik, vigrecexr and modrecexr variables, and also concluded that we didn't have enough evidence to reject the independence between the InRange variable with Work Activities.

```{r}
Nhanes<-nhanes%>%select(bmi,vigwrk,modwrk,wlkbik,vigrecexr,modrecexr)%>%na.omit()%>%
  mutate(InRange=factor((ifelse(bmi>18.5 & bmi <30, "Yes", "No")), levels = c("Yes", "No")))
tests<-IndepTest$new(Nhanes, c("vigwrk","modwrk","wlkbik","vigrecexr","modrecexr"), "InRange")
tests$pval_df%>%
  kable(caption = "p-values of Independence Tests between Different Variables and HealthyRange of BMI")%>%
  kable_styling(bootstrap_options=c("striped","condensed"),position="float_left")
```

Then we computed the marginal and aggregated Odds Ratios given levels of Vigorous Work Activities.

```{r}
Nhanes1<-Nhanes1%>%mutate(InRange=factor((ifelse(bmi>18.5 & bmi <30, "Yes", "No")), levels = c("Yes", "No")))
Nhanes2<-Nhanes2%>%mutate(InRange=factor((ifelse(bmi>18.5 & bmi <30, "Yes", "No")), levels = c("Yes", "No")))

tbl1<-Nhanes1%>%filter(vigwrk=="Yes")%>%group_by(across(c(InRange, vigrecexr), as.factor))%>%tally()%>%spread(key=vigrecexr, value=n)
tbl1%>%
  rename("\t" = InRange)%>%
  add_column(" " = c("InRange", rep(" ", nrow(.) - 1)), .before = "\t") %>%
  kable(caption = "Conditional Contingency Table")%>%
  kable_styling(bootstrap_options=c("striped","condensed"),full_width=F,position="float_left")%>%
  add_header_above(c(" " = 1, " " = 1, "Recreational|VigW=Y" = 2))%>%
  column_spec(1:2,bold=TRUE)
```

```{r}
tbl2<-Nhanes1%>%filter(vigwrk=="No")%>%group_by(across(c(InRange, vigrecexr), as.factor))%>%tally()%>%spread(key=vigrecexr, value=n)
tbl2%>%
  rename("\t" = InRange)%>%
  add_column(" " = c("InRange", rep(" ", nrow(.) - 1)), .before = "\t") %>%
  kable(caption = "Conditional Contingency Table")%>%
  kable_styling(bootstrap_options=c("striped","condensed"),full_width=F, position="float_left")%>%
  add_header_above(c(" " = 1, " " = 1, "Recreational|VigW=N" = 2))%>%
  column_spec(1:2,bold=TRUE)
```

```{r}
# Aggregate over all levels of Vigorous Work Activities
tbl3<-Nhanes1%>%group_by(across(c(InRange, vigrecexr), as.factor))%>%tally()%>%spread(key=vigrecexr, value=n)
tbl3%>%
  rename("\t" = InRange)%>%
  add_column(" " = c("InRange", rep(" ", nrow(.) - 1)), .before = "\t") %>%
  kable(caption = "Marginal Contingency Table, Aggregate VigW")%>%
  kable_styling(bootstrap_options=c("striped","condensed"),full_width=F, position="left")%>%
  add_header_above(c(" " = 1, " " = 1, "Recreational" = 2))%>%
  column_spec(1:2,bold=TRUE)
```

```{r}
list(tbl1, tbl2, tbl3)%>%map(function(x){ungroup(x)%>%select(-InRange)})%>%oddsratio(row.names = c("VigW=Y", "VigW=N", "Aggregated VigW"))%>%
  kable(caption = "OddsRatio for Conditional and Marginal Probability")%>%
  kable_styling(bootstrap_options=c("striped","condensed"),full_width=F, position="float_left")%>%
  column_spec(1,bold=TRUE)
```

In all cases we have an Odds ratio greater than 1, indicating that doing vigorous recreational activities can lower the odds of getting a risky BMI, regardless of having the vigorous work activities or not. This gave us a potential suggestion to those who have to work for a long time without gaining adequate physical activities. Recreational activity seems to play a more important role in maintaining a healthy level of body weight.

We then checked that given the body weight falls within the healthy range, was there a difference between which intensity of recreational activities has been experienced. Let the probability of having a BMI inside the healthy range of 18.5 to 30 for doing vigorous recreational activities as $p_{VigR}$, and for moderate recreational activities as $p_{ModR}$. We want to test the hypothesis:

```{=tex}
\begin{gather*}
H_0: p_{VigR} \leq p_{ModR}\\
H_1:p_{VigR} > p_{ModR}
\end{gather*}
```

```{r}
Vig_Rec1<-nhanes%>%transmute(InRange=factor((ifelse(bmi>18.5 & bmi <30, "Yes", "No")), levels = c("Yes", "No")), vigrecexr)%>%na.omit()%>%
  filter(vigrecexr=="Yes")%>%group_by(InRange)%>%count()
colnames(Vig_Rec1)<-c("InRange", "Vigorous Recreational=Y")

Mod_Rec1<-nhanes%>%transmute(InRange=factor((ifelse(bmi>18.5 & bmi <30, "Yes", "No")), levels = c("Yes", "No")), modrecexr)%>%na.omit()%>%
  filter(modrecexr=="Yes")%>%group_by(InRange)%>%count()
colnames(Mod_Rec1)<-c("InRange", "Moderate Recreational=Y")

p1<-1028/(1028+371)
p2<-1657/(1657+828)
z1<-(p1-p2)/sqrt(p1*(1-p1)/(1028+371) + p2*(1-p2)/(1657+828))

Vig_Rec2<-nhanes%>%transmute(InRange=factor((ifelse(bmi>18.5 & bmi <30, "Yes", "No")), levels = c("Yes", "No")), vigrecexr)%>%na.omit()%>%
  filter(vigrecexr=="No")%>%group_by(InRange)%>%count()
colnames(Vig_Rec2)<-c("InRange", "Vigorous Recreational=N")

Mod_Rec2<-nhanes%>%transmute(InRange=factor((ifelse(bmi>18.5 & bmi <30, "Yes", "No")), levels = c("Yes", "No")), modrecexr)%>%na.omit()%>%
  filter(modrecexr=="No")%>%group_by(InRange)%>%count()
colnames(Mod_Rec2)<-c("InRange", "Moderate Recreational=N")

p1<-2981/(2981+2064)
p2<-2351/(2351+1607)
z2<-(p1-p2)/sqrt(p1*(1-p1)/(2981+2064) + p2*(1-p2)/(2351+1607))

merge(merge(Vig_Rec1, Vig_Rec2, by="InRange"), merge(Mod_Rec1, Mod_Rec2, by="InRange"), by="InRange")%>%
  kable(caption="Frequency Table")%>%kable_styling(bootstrap_options=c("striped","condensed"),position="left")%>%
  column_spec(1,bold = TRUE)

```

```{r}
data.frame(VigR_Yes=pnorm(-z1), VigR_No=pnorm(z2), row.names = "pvalue")%>%
  kable(caption = "pvalues for two-sample test")%>%
  kable_styling(bootstrap_options=c("striped","condensed"),full_width=F,position="float_left")%>%
  column_spec(1, width = "10em", bold = TRUE)
```

We gained the MLE of the parameters from the Frequency Table 3.16 as:

\begin{gather*}
p_{VigR=Y} = \frac{1028}{1028+371}, ~ p_{ModR=Y} = \frac{1657}{1657+828} \\
p_{VigR=N} = \frac{2981}{2981+2064}, ~ p_{ModR=N} = \frac{2351}{2351+1607} \\
\end{gather*}

Our conclusion was that we did see there was a higher probability of getting the healthy weight when Vigorous Recreational Activities were done. However when choosing the moderate level of recreational activities, there's no conclusion in the hypothesis test.

In all, we saw from our analysis that having vigorous or moderate recreational activities tend to give healthy range of BMI, while moderate or vigorous work activities might not have an significant influence on body weight conditions.

## Exrtra topic: Survey weights in complex survey designs

Most large-scale surveys often involve a combination of multiple sampling design techniques, like stratification and cluster sampling, enable researchers to obtain accurate estimates while catering to practical and cost considerations. A central tenet to these designs is the concept of sampling weights, pivotal in ensuring unbiased estimation.

Sampling weights are best defined as the inverse of the probability that a specific unit gets selected in the sample. These weights adjust for design-imposed inequalities in selection probabilities and are used tp compute point estimates.

In the case of the stratified random sampling. The population U of size N is partitioned into stratums denoted by $U_1,...,U_h,...,U_H$. The size of $h$th stratum is denoted by $N_h$.In stratum $h$, a random sample $S_h$ of size $n_h$ is selected based on a sampling design, here we use simple random sampling for simplicity and efficiency. In this stratified random sampling, the estimate of population total can be show as following[@Lohr_2022]:

$\hat{t}_{str}=\sum_{h=1}^H\sum_{j\in S_h}w_{hj}y_{hj}$

where the $w_{hj}=N_h/n_h$ represents the sampling weight of the $j$th observation in the $h$th stratum, $y_{hj}$. Note that the probability of sample selection of the $j$th unit in the $h$th stratum is $\pi_{hj}=n_h/N_h$.In this case, the sampling weight is the inverse of such probability $\pi_{hj}$. The unbiased estimator of the population mean $\bar{y}_U$ can also be shown with sampling weight as following[@Lohr_2022]:

$\hat{\bar{y}}_{str}=\frac{\sum_{h=1}^H\sum_{j\in S_h}w_{hj}y_{hj}}{\sum_{h=1}^H\sum_{j\in S_h}w_{hj}}$

Cluster sampling is another complex sampling technique for large-scale surveys when the population elements are dispersed and the the fieldwork is costly. We sample the primary sampling units(psu's) which are often from the natural groupings of the population elements. In cluster sampling, we have $N$ as the number of psu's in the population. $i$th psu contains $M_i$ elements. For sample of psu's, $S$, We denote $n$ as the number of psu's in the sample. For a two-stage cluster sampling, a $S_i$ sub-sample of secondary sampling units(ssu's) is chosen from $i$th psu, $i=1,...,n$. The sub-sample size is $m_i$.

In the case of two-stage cluster sampling with equal probabilities, the sampling weight can be expressed as the following: $w_{ij}=1/\pi_{ij}=\frac{NM_i}{nm_i}$, where $\pi_{ij}$ is the probability that the $j$th ssu in the $i$th psu is in the sample. For unequal probabilities, we need the probability that the $i$th psu is in the sample,$\pi_i$, and the probability that the $j$th ssu is in the sample given that the $i$th psu is in the sample, $\pi_{j|i}$. Then, the sampling weight is given by $w_{ij}=1/(\pi_i\pi_{j|i})$.

With the sampling weight shown above, the estimator of the population total in cluster sampling can also be show in the following forms[@Lohr_2022]:

$\hat{t}=\sum_{i\in S}\sum_{j\in S_i}w_{ij}y_{ij}$

and the estimator of the population mean:

$\hat{\bar{y}}=\frac{\sum_{i\in S}\sum_{j\in S_i}w_{ij}y_{ij}}{\sum_{i\in S}\sum_{j\in S_i}w_{ij}}$

In essence, sampling weights in complex survey designs play a crucial role in ensuring that the survey results are both accurate and generalizable to the broader population.

# Conclusion

In our analysis of the NHANES dataset, significant associations were identified between body weight, age, gender, cholesterol levels, and blood pressure. Lifestyle factors, especially of vigorous recreational activities, were linked to healthier BMI ranges, emphasizing their importance in weight management. While marital status did not show a significant relationship with obesity, other factors like age and type of physical activity did impact weight. However, these findings should be interpreted cautiously due to potential confounding variables not accounted for in the dataset.

# References

