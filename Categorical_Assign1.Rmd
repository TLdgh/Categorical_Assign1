---
title: "MAT5317 Categorical Assignment 1"
author:
- Teng Li(7373086)
- Zhize Lu(300075114)
- Chutong Zhang(300311325)
output: bookdown::html_document2
header-includes:
- \renewcommand{\and}{\\}
- \usepackage{float}
- \floatplacement{figure}{H}
bibliography: References.bib
link-citations: yes
---


<style type="text/css">
body{
font-size: 12pt;
}
table{
font-size: 12pt;
}
</style>

```{r setup, echo=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
library(plotly)
library(tidyverse)
library(kableExtra)
library(aplore3)
library(table1)
source("CodeSpace.R")
```

# Introduction

We were given the data set of The National Health and Nutrition Examination Survey (NHANES). The survey program has been conducted as a series of surveys designed to assess the health and nutritional status of adults and children in the United States since the 1960s, according to CDC [@CDC]. It combines in-person face-to-face interviews and physical examinations of participants for data collection.

The survey data wasn't a simple random sample, however. According to CDC's National Health and Nutrition Examination Survey: Plan and Operations, 1999--2010 [@SurveyDesign], the sampling strategy consists of several stages: 1. Selection of counties as primary sampling units (PSU). 2. selection of segments within PSUs that constitute blocks of households. 3. Selection of specific households within segments. 4. Selection of individuals within a household.

We aim to study the relationship between the weight variable and the other health related variables of the data.

# Method

We began our study by doing an exploratory analysis among the variables through various tables and charts. We then performed several hypothesis tests on some of the variables. Lastly we did a linear regression model fit to the response variable "weight" with other variables and confounders.

# Analysis

We began our analysis by giving a data dictionary of the data shown in Table 1 below. As one can see that some variables have a high percentage of missing values. In Part 2 we made hypothesis tests to decide if some of these variables could be excluded from the regression analysis in Part 3.

The weight variable was a continuous random variable in our data. A simple way of categorizing it was to consider the BMI indicator. As one could see there was an obese variable in the data. The weight variable was categorized by giving a threshold of 35 to the BMI value. A person is considered healthy if the BMI is below 35, and obese otherwise. Therefore, we used the obese variable as the categorical random variable in our project.

The  NHANES III data set from 2009-2010 is an ongoing and continuous survey focused on civilian noninstitutional population fo the United states and published by CDC every year, it is designed to be a surveillance of specific diseases and behaviors,providing statistical insights into the U.S population.[@SurveyDesign] In this assignment, we accessed the data set from the aplore3 package in R, which contains 6482 observations in 21 variables.Of these, 8(gender, marstat, vigwrk, modwrk, wlkbik, vigrecexr, and obesity)can be considered as categorical variables, while the rest as numerical variables.

In categorical variables, we need to specified the vigorous work or recreational activities and moderate work or recreational activities. vigorous work or recreational activities means that intense physical exertion leading to significant elevation in respiration and heart rate, it usually sustained for more than 10 minutes during the work or recreational activities. Moderate work and recreational activities means that activities require moderate physical effort and results in slight increase in respiration and heart rate, it usually sustained for less than 10 minutes during the work or recreational activities.[@CODE] 

In numerical variables, we also want to elucidate several variables related to cholesterol and blood pressure. Cholesterol is a type of lipid that helps body perform important body functions. Tchol indicates the Total Cholesterol, it is the total number of cholesterol circulation in people's blood. Hdl indicates the HDL-Cholesterol, it is the high-density lipoprotein cholesterol that helps people transfer excess cholestrol from the blood to the liver.[@CHOL] Sysbp stands for Systolic Blood Pressure and dbp stands for Diastolic Blood Pressure, systolic pressure repersents the maximum blood pressure when ventricles contract, while diastolic pressure denotes the minimum blood pressure registered just before the subsequent contraction.[@BP] We will discuss the thresholds for cholesterol and blood pressure in the following discussion. Two other variables in this dataset are worth noticing, psu and strata, it is the Pseudo-PSU and Pseudo-stratum used in sampling strategy. In this data set, stratum was defined by geography and psu were selected from every stratum with probability proportional to a measure of size(PPS). More details about survey weights for NHANES will be presented in the extra topic part.

In original data set, it exists 6482 observations and 37 of them are missing information for variable bmi. We deleted these missing data,only perform 6445 observations as total sample size and use BMI level to stratified observations, since the missing data less than 0.6% in total. As can be seen in table 1, the first three columns are different level of BMI based on CDC's classification,the last column is the overall performance for every variables. For categorical variables, first three column presented the total number of observation and percentage under the stratification condition, last column is the sum of the first three column and the percentage of the total observations. For numerical variables, first three columns are the mean and standard deviation under the stratification condition and the last column is the mean and standard deviation under overall level.
```{r}
#Table 1 
Bnhanes<-nhanes
Bnhanes<-mutate(Bnhanes,BMI_level = case_when(
  Bnhanes$bmi < 18.5 ~"Underweight",
  Bnhanes$bmi < 25 ~"Healthy weight",
  Bnhanes$bmi < 30 ~"Overweight",
  Bnhanes$bmi >= 30 ~"Obesity "))%>%
  filter(!is.na(Bnhanes$bmi))

label(Bnhanes$gender) <- "Gender"
label(Bnhanes$age)<-"Age"
label(Bnhanes$marstat)<-"Marital Status"
label(Bnhanes$samplewt)<-"Statistical Weight"
label(Bnhanes$psu)<-"Pseudo-PSU"
label(Bnhanes$strata)<-"Pseudo-stratum"
label(Bnhanes$tchol)<-"Total Cholesterol"
label(Bnhanes$hdl)<-"HDL-Cholesterol"
label(Bnhanes$sysbp)<-"Systolic Blood Pressure"
label(Bnhanes$dbp)<-"Diastolic Blood Pressure "
label(Bnhanes$wt)<-"Weight"
label(Bnhanes$ht)<-"Standing Height"
label(Bnhanes$bmi)<-"Body mass Index"
label(Bnhanes$vigwrk)<-"Vigorous Work Activity"
label(Bnhanes$modwrk)<-"Moderate Work Activity "
label(Bnhanes$wlkbik)<-"Walk or Bicycle "
label(Bnhanes$vigrecexr)<-"Vigorous Recreational Activities "
label(Bnhanes$modrecexr)<-"Moderate Recreational Activities"
label(Bnhanes$sedmin)<-"Minutes of Sedentary Activity per Week "
label(Bnhanes$obese)<-"Obese "

units(Bnhanes$age) <- "years"
units(Bnhanes$tchol) <- "mg/dL"
units(Bnhanes$hdl) <- "mg/dL"
units(Bnhanes$sysbp) <- "mm Hg"
units(Bnhanes$dbp) <- "mm Hg"
units(Bnhanes$wt) <- "Kg"
units(Bnhanes$ht) <- "cm"
units(Bnhanes$bmi) <- "Kg/m^2"
units(Bnhanes$sedmin) <- "mins"

my.render.cont <- function(x) {
  with(stats.apply.rounding(stats.default(x), digits=3), c("",
                                                           "Mean (SD)"=sprintf("%s (Â± %s)", MEAN, SD)))
}

tbl<-table1 (~ gender+age+marstat+samplewt+psu+strata+tchol+hdl+sysbp+dbp+wt+ht+vigwrk+modwrk+wlkbik+vigrecexr+modrecexr+sedmin+obese |BMI_level,render.continuous=my.render.cont, data=Bnhanes)
kable(tbl,"html",caption="Characteristics of the data set NHANES")%>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

According to CDC's classification on bodyweight, we have: BMI\<18.5 as Underweight, BMI between 18.5 and 24.9 as Health, BMI between 25 and 29.9 as Overweight, and BMI\>30 as obesity. We adopted this category and found that there was a slight positive relationship between bodyweight and the total cholesterol level. However, we noticed that there was a negative relationship between the HDL and bodyweight. Because of the fact that Tchol is the sum of HDL and LDL, we can conclude that the obese population has a high level of LDL and a low level HDL.

```{r, fig.cap="Mean Cholesterol level across Categories of Body Weight"}
nhanes%>%mutate(CDC_obese=case_when(
  bmi <18.5 ~ "Underweight", 
  bmi>=18.5 & bmi<=24.9 ~ "Healthy",
  bmi>24.9 & bmi<=29.9 ~ "Overweight",
  bmi>29.9  ~ "Obesity"
))%>%transmute(CDC_obese=factor(CDC_obese, levels=c("Underweight", "Healthy", "Overweight", "Obesity")), tchol, hdl)%>%na.omit()%>% group_by(CDC_obese)%>%summarise(Mean_tchol=mean(tchol), Mean_hdl=mean(hdl))%>%gather("Type", "Value",Mean_tchol:Mean_hdl)%>%
  plot_ly(x=~CDC_obese, y=~Value, color = ~Type, type = "scatter", mode="lines", height = 300,width = 500)%>%
  layout(
    yaxis = list(range = c(45, 200),dtick = 50)
  )
```

According to ATPIII [@ATP], we can also categorize the cholesterol level.

This data set mainly focus on the observers between 16 to 80 years old. Among them, the average weight for male is greater than female among all ages, and as we can see from the line chart that the change in average weight with age follow the same trend across the gender, with a general tendency to sustained increase, followed by fluctuation and continuous decrease finally. It can be considered as there might exist some relationship with weight and age.
```{r, fig.cap="Average Weight in Different Age"}
#exploratory average weight in every age grouped by gender
gender<-nhanes%>%
  group_by(gender,age)%>%
  summarise(Avgwt=mean(wt,na.rm=TRUE), .groups="drop")
ggplot(gender,aes(x=age, y=Avgwt), group=gender)+
  geom_point(aes(colour=gender),size=1 )+
  geom_line(aes(fill=gender,colour=gender,linetype=gender) )+
  geom_hline(yintercept = 86.2, linetype="dotted", size = 0.5)+
  geom_hline(yintercept = 74.9, linetype="dotted", size = 0.5)+
  annotate("text", y=86.2, x=18, label=" Male Avg.")+
  annotate("text", y=74.9, x=18, label="Female Avg.")+
  scale_y_continuous( labels = scales::comma  ) +
  theme(axis.text.x = element_text(size =7, vjust = 0.5, hjust = 0.5, angle = 45))+
  
  labs(x="Age", y="Average weight (Kg)")+
  theme(plot.title = element_text(hjust = 0.5))
```

For the observations in different marital status, we also interested in the relationship between weight and marital status.The following box plot shows that the median weight under different marital status are all around 80 Kg, widowed observation have lowest weight among six categories. Married and Never Married observations have more people heavier than 130 Kg than other categories, which may not good for health.
```{r, fig.cap="Boxplot of Weight for Different Marital Status"}
#box plot for weight VS marital status
Nhanes<-nhanes%>%
  na.omit()
ggplot(Nhanes, aes(x=marstat, y=wt, fill=marstat))+
  geom_boxplot() + 
  scale_fill_brewer(palette="Blues") +
  labs(x="Marital Status", y="Weight (Kg)")+
  theme(axis.text.x = element_text(size =7, vjust = 0.5, hjust = 0.5, angle = 45),
        plot.title = element_text(hjust = 0.5)
  )
```

We then want to analyze the relationship between body weight and human activities. The two types of activity measures were given in the data, the work activity and the recreational activity. We explored different intensity levels of work and recreational activities and their potential relationships. From Figure below one can see that the vigorous recreational activities yield BMI observations between the healthy range of 18.5 to 30, regardless of the condition on work activities. However, the non-vigorous recreational activities yield systemically higher levels of BMI than that of the vigorous recreational activities, again regardless of the condition on work activities. We observed the same pattern when considering moderate intensity of work and recreational activities in Figure . If one do a vertical comparison between the intensity of activities, there was no significant difference, except that vigorous recreational activities lower the 25% to 75% quantile range of BMI a little closer to the healthy interval than moderate recreational activities do. Therefore we suspect that recreational activity plays more important row in determining the level of BMI than work activity.
```{r, fig.cap="Boxplot of BMI for Different Vigorous Activities"} 
#boxplot for Vigorous activities VS bmi
Nhanes1<-nhanes%>%select(bmi, vigwrk, vigrecexr)%>%na.omit()
Nhanes1$vigrecexr<-factor(Nhanes1$vigrecexr, levels = c("Yes", "No"), labels = c("Vigorous Recreational Activities", "No Vigorous Recreational Activities"))

#boxplot for Moderate activities VS bmi
Nhanes2<-nhanes%>%select(bmi, modwrk, modrecexr)%>%na.omit()
Nhanes2$modrecexr<-factor(Nhanes2$modrecexr, levels = c("Yes", "No"), labels = c("Moderate Recreational Activities", "No Moderate Recreational Activities"))


ggplot(Nhanes1, aes(x=vigwrk, y=bmi, fill=vigwrk))+
  geom_boxplot() + 
  facet_wrap(~vigrecexr) +
  scale_fill_brewer(palette="Blues") +
  geom_hline(yintercept = 18.5, linetype="dotted", size = 0.5)+
  geom_hline(yintercept = 30, linetype="dotted", size = 0.5)+
  annotate("text", y=18.5, x="Yes", label=" underweight")+
  annotate("text", y=30,x="Yes", label=" obsity")+
  labs(x="Vigorous Work Activity", y="BMI")+
  theme(axis.text.x = element_text(size =7, vjust = 0.5, hjust = 0.5, angle = 45),
        plot.title = element_text(hjust = 0.5)
  )
```

```{r, fig.cap="Boxplot of BMI for Different Moderate Activities"} 

ggplot(Nhanes2, aes(x=modwrk, y=bmi, fill=modwrk))+
  geom_boxplot() + 
  facet_wrap(~modrecexr,ncol = 2) +
  scale_fill_brewer(palette="Blues") +
  geom_hline(yintercept = 18.5, linetype="dotted", size = 0.5)+
  geom_hline(yintercept = 30, linetype="dotted", size = 0.5)+
  annotate("text", y=18.5, x="Yes", label=" underweight")+
  annotate("text", y=30,x="Yes", label=" obsity")+
  labs(x="Moderate Work Activity", y="BMI")+
  theme(axis.text.x = element_text(size =7, vjust = 0.5, hjust = 0.5, angle = 45),
        plot.title = element_text(hjust = 0.5)
  )
```

We therefore have a three way table:
```{r}
Nhanes1<-Nhanes1%>%mutate(InRange=factor((ifelse(bmi>18.5 & bmi <30, "Yes", "No")), levels = c("Yes", "No")))
Nhanes2<-Nhanes2%>%mutate(InRange=factor((ifelse(bmi>18.5 & bmi <30, "Yes", "No")), levels = c("Yes", "No")))

tbl1<-Nhanes1%>%filter(vigwrk=="Yes")%>%group_by(across(c(InRange, vigrecexr), as.factor))%>%tally()%>%spread(key=vigrecexr, value=n)
tbl1%>%
  rename("\t" = InRange)%>%
  add_column(" " = c("InRange", rep(" ", nrow(.) - 1)), .before = "\t") %>%
  kable(caption = "Contingency Table for InRange and Levels of Recreational Activities, given Vigorous Work Activities")%>%
  kable_styling(bootstrap_options=c("striped","condensed"),full_width=F,position="center")%>%
  add_header_above(c(" " = 1, " " = 1, "Recreational Activities | Vigorous Work Activities = Yes" = 2))%>%
  column_spec(1:2,width = "10em",bold=TRUE)

tbl2<-Nhanes1%>%filter(vigwrk=="No")%>%group_by(across(c(InRange, vigrecexr), as.factor))%>%tally()%>%spread(key=vigrecexr, value=n)
tbl2%>%
  rename("\t" = InRange)%>%
  add_column(" " = c("InRange", rep(" ", nrow(.) - 1)), .before = "\t") %>%
  kable()%>%
  kable_styling(bootstrap_options=c("striped","condensed"),full_width=F, position="center")%>%
  add_header_above(c(" " = 1, " " = 1, "Recreational Activities | Vigorous Work Activities = No" = 2))%>%
  column_spec(1:2,width = "10em",bold=TRUE)
```

Assuming the risk $p$ is defined as the probability of having a BMI not inside the range of 18.5 to 30, i.e. either being underweight or obesity. We defined $p_1$ as the risk for the participants with Vigorous Recreational Activities, and $p_2$ is the risk for those with No Vigorous Recreational Activities. We computed the marginal and aggregated Odds Ratios given levels of Vigorous Work Activities.

```{r}
# Aggregate over all levels of Vigorous Work Activities
tbl3<-Nhanes1%>%group_by(across(c(InRange, vigrecexr), as.factor))%>%tally()%>%spread(key=vigrecexr, value=n)
list(tbl1, tbl2, tbl3)%>%map(function(x){ungroup(x)%>%select(-InRange)})%>%oddsratio(row.names = c("Given vigwrk==Yes", "Given vigwrk==No", "Aggregated vigwrk"))%>%
  kable(caption = "OddsRatio for Conditional and Marginal Probability")%>%
  kable_styling(bootstrap_options=c("striped","condensed"),full_width=F, position="float_left")%>%
  column_spec(1,bold=TRUE)

```

In all cases we have an Odds ratio greater than 1, indicating that doing vigorous recreational activities can lower the odds of getting a risky BMI, regardless of having the vigorous work activities or not. This gave us a potential suggestion to those who have to work for a long time without gaining adequate physical activities. The recreational activities seems to play a more important role in maintaining a healthy level of body weight.

We then checked that given the body weight falls within the healthy range, is there a difference between which intensity of recreational activities has been experienced. Let the probability of having a BMI inside the healthy range of 18.5 to 30 for doing vigorous recreational activities as $p_1$, and for moderate recreational activities as $p_2$. We want to test the hypothesis:

```{=tex}
\begin{gather*}
H_0: p_{1} \leq p_{2}\\
H_1:p_{1} > p_{2}
\end{gather*}
```

```{r}
Vig_Rec1<-nhanes%>%transmute(InRange=factor((ifelse(bmi>18.5 & bmi <30, "Yes", "No")), levels = c("Yes", "No")), vigrecexr)%>%na.omit()%>%filter(vigrecexr=="Yes")%>%group_by(InRange)%>%count()
colnames(Vig_Rec1)<-c("InRange", "Vigorous Recreational Activities=Yes")


Mod_Rec1<-nhanes%>%transmute(InRange=factor((ifelse(bmi>18.5 & bmi <30, "Yes", "No")), levels = c("Yes", "No")), modrecexr)%>%na.omit()%>%filter(modrecexr=="Yes")%>%group_by(InRange)%>%count()
colnames(Mod_Rec1)<-c("InRange", "Moderate Recreational Activities=Yes")

p1<-1028/(1028+371)
p2<-1657/(1657+828)
z1<-(p1-p2)/sqrt(p1*(1-p1)/(1028+371) + p2*(1-p2)/(1657+828))

Vig_Rec2<-nhanes%>%transmute(InRange=factor((ifelse(bmi>18.5 & bmi <30, "Yes", "No")), levels = c("Yes", "No")), vigrecexr)%>%na.omit()%>%filter(vigrecexr=="No")%>%group_by(InRange)%>%count()
colnames(Vig_Rec2)<-c("InRange", "Vigorous Recreational Activities=Yes")

Mod_Rec2<-nhanes%>%transmute(InRange=factor((ifelse(bmi>18.5 & bmi <30, "Yes", "No")), levels = c("Yes", "No")), modrecexr)%>%na.omit()%>%filter(modrecexr=="No")%>%group_by(InRange)%>%count()
colnames(Mod_Rec2)<-c("InRange", "Moderate Recreational Activities=Yes")

p1<-2981/(2981+2064)
p2<-2351/(2351+1607)
z2<-(p1-p2)/sqrt(p1*(1-p1)/(2981+2064) + p2*(1-p2)/(2351+1607))

merge(merge(Vig_Rec1, Mod_Rec1, by="InRange"), merge(Vig_Rec2, Mod_Rec2, by="InRange"), by="InRange")%>%
  kable(caption="Frequency Table")%>%kable_styling(bootstrap_options=c("striped","condensed"),full_width=F,position="float_left")
```

```{r}
data.frame(vigrecexr=pnorm(-z1), modrecexr=2*pnorm(z2), row.names = "pvalue")%>%
  kable(caption = "pvalues for two-sample test")%>%
  kable_styling(bootstrap_options=c("striped","condensed"),full_width=F,position="float_left")
```

Our conclusion is that we did see there's a higher probability of getting the healthy weight when Vigorous Recreational Activities are done. However when choosing the moderate level of recreational activities, there's no conclusion in the hypothesis test.

In general, we can see from two plots that observations have vigorous or moderate recreational activities trend to have healthy BMI index than others,and under same recreational activities condition observations in moderate or vigorous work activities have less number of observations have high BMI index. Hence, different types of work or recreational activities may have relationship with weight and affect BMI index in this way.

## Part 2: Hypothesis Tests

We first test the independence between obesity and marital status. We form the following contingency table:

```{r}
test_marstat<-IndepTest$new(nhanes, "marstat", "obese")
test_marstat$ContingencyTbl$marstat%>%
  rename("\t" = marstat) %>%
  add_column(" " = c("Marital Status", rep(" ", nrow(.) - 1)), .before = "\t") %>%
  kable(caption = "Contingency Table")%>%
  kable_styling(bootstrap_options=c("striped","condensed"),position="float_left")%>%
  add_header_above(c(" " = 1, " " = 1, "Obesity" = 2))%>%
  column_spec(1:2,width = "10em",bold=TRUE)
```
```{r}
test_marstat$pval_df%>%
  kable(caption = "pvalues for Chi-squared Independence Test")%>%
  kable_styling(bootstrap_options=c("striped","condensed"),full_width=F,position="float_left")%>%
  column_spec(2,width = "15em",bold=TRUE)
```

Let X be the categorical random variable for Marital Status and Y be the one for Obesity. Assuming a random sample of n trials. Define the count random variable $N_{ij}:=\sum_{k=1}^n \mathbf{I}_k(X=i, Y=j)$ where $\mathbf{I}_k$ is the indicator function for the k-th trial, then the joint random variables $[N_{11}, ..., N_{IJ}]$ has a Multinomial distribution $\vec{p}=[p_{11}, ..., p_{IJ}]$. Our hypothesis test is therefore:

```{=tex}
\begin{gather*}
H_0: p_{ij}= p_{i+} \cdot p_{+j} ~ \forall i,j\\
H_1:p_{ij} \neq p_{i+} \cdot p_{+j} ~ \forall i,j
\end{gather*}
```

We use the chi-squared test to conclude that there is not enough evidence to reject the null hypothesis with a p-value equal to 0.6894. In other words, we cannot conclude that there is a relationship between obesity and marital status.

We do the same test for other variables compared with obesity. From Table 2 we can see that we can reject the independence between obesity and wlkbik, vigrecexr and modrecexr variables.

```{r}
tests<-IndepTest$new(nhanes, c("vigwrk","modwrk","wlkbik","vigrecexr","modrecexr"), "obese")
tests$pval_df%>%
  kable(caption = "p-values of Independence Tests between Different Variables and Obesity")%>%
  kable_styling(bootstrap_options=c("striped","condensed"),position="float_left")
```

Based on thresholds established by clinicians, we categorizing four variables related to the cholesterol and blood pressure level.

Cholesterol is an essential fat in the body. According to American Heart Association, We have: tchol of 240mg/dl or higher OR hdl under 40mg/dL as Dangerous Cholesterol level; tchol between 200-239mg/dL OR hdl between 40-59mg/dL for males OR between 50-59mg/dL for females as at risk level; tchol under 200mg/dL and hdl of 60mg/dL and higher as healthy level.

Blood pressure is typically categorized into different stages based on the systolic (top number) and diastolic (bottom number) readings. According to American Heart Association, We have: systolic level less than 120mm Hg and diastolic level less than 80mm Hg as normal blood pressure; systolic level between 120-129mm Hg and diastolic level less than 80mm Hg as elevated blood pressure; systolic level between 130-139mm Hg OR diastolic level between 80-89mm Hg as Hypertension Stage 1; systolic level 140mm Hg or higher OR diastolic level 90mm Hg or higher as Hypertension Stage 2; systolic level higher than 180mm Hg OR diastolic level higher than 120mm Hg as Hypertensive Crisis.

```{r}
#Categorization
nhanes_data <- nhanes

nhanes_data <- nhanes_data[complete.cases(nhanes_data[, c("bmi", "gender", "tchol", "hdl", "sysbp", "dbp")]), ]

# Categorize body weight based on BMI
nhanes_data$weight_category <- with(nhanes_data, ifelse(
  bmi < 18.5, "Underweight",
  ifelse(bmi >= 18.5 & bmi <= 24.9, "Healthy",
         ifelse(bmi >= 25 & bmi <= 29.9, "Overweight", "Obese"))))

# Categorizing cholesterol levels
nhanes_data$chol_category <- with(nhanes_data, ifelse(
  tchol >= 240 | hdl < 40, "Dangerous",
  ifelse(
    tchol >= 200 & tchol < 240 | 
      (gender == "Male" & hdl >= 40 & hdl < 60) |  # Male and HDL between 40-59
      (gender == "Female" & hdl >= 50 & hdl < 60),   # Female and HDL between 50-59
    "At Risk",
    "Healthy"
  )
))

# Preview
#head(nhanes_data[, c("gender","tchol", "hdl", "chol_category")])

# Categorizing blood pressure
nhanes_data$bp_category <- with(nhanes_data, ifelse(
  sysbp < 120 & dbp < 80, "Normal",
  ifelse(sysbp >= 120 & sysbp <= 129 & dbp < 80, "Elevated",
  ifelse(sysbp > 180 | dbp > 120, "Hypertensive Crisis",
  ifelse(sysbp >= 140 | dbp >= 90, "Hypertension Stage 2",
  ifelse((sysbp >= 130 & sysbp <= 139) | (dbp >= 80 & dbp <= 89), "Hypertension Stage 1", NA))))))

# Preview
#head(nhanes_data[, c("sysbp", "dbp", "bp_category")])
```

After categorizing Cholesterol level and blood pressure, we create three contingency tables:

```{r}
test1 <- IndepTest$new(nhanes_data, "weight_category", "chol_category")
test2 <- IndepTest$new(nhanes_data, "weight_category", "bp_category")
test3 <- IndepTest$new(nhanes_data, "chol_category", "bp_category")

#contingency table for Weight vs. Cholesterol
table_weight_chol <- test1$ContingencyTbl$weight_category %>%
  rename("\t" = weight_category) %>%
  add_column(" " = c("Weight", rep(" ", nrow(.) - 1)), .before = "\t") %>%
  kable(caption = "Contingency Table: Weight vs. Cholesterol") %>%
  kable_styling(bootstrap_options = c("striped", "condensed"), position = "float_left") %>%
  add_header_above(c(" " = 1, " " = 1, "Cholesterol" = 3)) %>%
  column_spec(1:2, width = "10em", bold = TRUE)
table_weight_chol
```

```{r}
#contingency table for Weight vs. Blood Pressure
table_weight_bp <- test2$ContingencyTbl$weight_category %>%
  rename("\t" = weight_category) %>%
  add_column(" " = c("Weight", rep(" ", nrow(.) - 1)), .before = "\t") %>%
  kable(caption = "Contingency Table: Weight vs. Blood Pressure") %>%
  kable_styling(bootstrap_options = c("striped", "condensed"), position = "float_left") %>%
  add_header_above(c(" " = 1, " " = 1, "Blood Pressure" = 5)) %>%
  column_spec(1:2, width = "10em", bold = TRUE)
table_weight_bp
```

```{r}
#contingency table for Cholesterol vs. Blood Pressure
table_chol_bp <- test3$ContingencyTbl$chol_category %>%
  rename("\t" = chol_category) %>%
  add_column(" " = c("Cholesterol", rep(" ", nrow(.) - 1)), .before = "\t") %>%
  kable(caption = "Contingency Table: Cholesterol vs. Blood Pressure") %>%
  kable_styling(bootstrap_options = c("striped", "condensed"), position = "float_left") %>%
  add_header_above(c(" " = 1, " " = 1, "Blood Pressure" = 5)) %>%
  column_spec(1:2, width = "10em", bold = TRUE)
table_chol_bp
```

```{r}
pvals<-data.frame(test1$pval_df, test2$pval_df, test3$pval_df)
colnames(pvals)<-c("Weight VS Cholesterol", "Weight VS. Blood Pressure", "Cholesterol VS. Blood Pressure")

pvals%>%kable(caption = "p-values of Independence Tests between Variables") %>%
  kable_styling(bootstrap_options = c("striped", "condensed"), position = "float_left")
```
We also conducted hypothesis testing using Pearson chi-squared test. The p-value for weight and cholesterol is extremely small, equals to $1.475\times10^{-53}$. This suggest that there is a statistically significant association between weight and cholesterol levels. For weight against blood pressure, the p-value is $5.723\times10^{-35}$ which indicates that between weight and blood pressure, there is significant relationship. Cholesterol level is also associated with blood pressure with a p-value equals to $3.286\times10^{-13}$.

However, there are potential confounding variables like age, diet, etc. Some of the variables are not recorded in the data. For further study, we need to conduct stratified analysis. 

The results suggest that there is a significant association between weight, cholesterol, and blood pressure. The patterns observed in the contingency tables align with general health knowledge: obesity is a risk factor for both high cholesterol and high blood pressure. 

## Exrtra topic: Survey weights in complex survey designs

Most large-scale surveys often involve a combination of multiple sampling design techniques, like stratification and cluster sampling, enable researchers to obtain accurate estimates while catering to practical and cost considerations. A central tenet to these designs is the concept of sampling weights, pivotal in ensuring unbiased estimation.

Sampling weights are best defined as the inverse of the probability that a specific unit gets selected in the sample. These weights adjust for design-imposed inequalities in selection probabilities and are used tp compute point estimates.

In the case of the stratified random sampling. The population U of size N is partitioned into stratums denoted by $U_1,...,U_h,...,U_H$. The size of $h$th stratum is denoted by $N_h$.In stratum $h$, a random sample $S_h$ of size $n_h$ is selected based on a sampling design, here we use simple random sampling for simplicity and efficiency. In this stratified random sampling, the estimate of population total can be show as following[@Lohr_2022]:

$\hat{t}_{str}=\sum_{h=1}^H\sum_{j\in S_h}w_{hj}y_{hj}$

where the $w_{hj}=N_h/n_h$ represents the sampling weight of the $j$th observation in the $h$th stratum, $y_{hj}$. Note that the probability of sample selection of the $j$th unit in the $h$th stratum is $\pi_{hj}=n_h/N_h$.In this case, the sampling weight is the inverse of such probability $\pi_{hj}$. The unbiased estimator of the population mean $\bar{y}_U$ can also be shown with sampling weight as following[@Lohr_2022]:

$\hat{\bar{y}}_{str}=\frac{\sum_{h=1}^H\sum_{j\in S_h}w_{hj}y_{hj}}{\sum_{h=1}^H\sum_{j\in S_h}w_{hj}}$

Cluster sampling is another complex sampling technique for large-scale surveys when the population elements are dispersed and the the fieldwork is costly. We sample the primary sampling units(psu's) which are often from the natural groupings of the population elements. In cluster sampling, we have $N$ as the number of psu's in the population. $i$th psu contains $M_i$ elements. For sample of psu's, $S$, We denote $n$ as the number of psu's in the sample. For a two-stage cluster sampling, a $S_i$ sub-sample of secondary sampling units(ssu's) is chosen from $i$th psu, $i=1,...,n$. The sub-sample size is $m_i$.

In the case of two-stage cluster sampling with equal probabilities, the sampling weight can be expressed as the following: $w_{ij}=1/\pi_{ij}=\frac{NM_i}{nm_i}$, where $\pi_{ij}$ is the probability that the $j$th ssu in the $i$th psu is in the sample. For unequal probabilities, we need the probability that the $i$th psu is in the sample,$\pi_i$, and the probability that the $j$th ssu is in the sample given that the $i$th psu is in the sample, $\pi_{j|i}$. Then, the sampling weight is given by $w_{ij}=1/(\pi_i\pi_{j|i})$.

With the sampling weight shown above, the estimator of the population total in cluster sampling can also be show in the following forms[@Lohr_2022]:

$\hat{t}=\sum_{i\in S}\sum_{j\in S_i}w_{ij}y_{ij}$

and the estimator of the population mean:

$\hat{\bar{y}}=\frac{\sum_{i\in S}\sum_{j\in S_i}w_{ij}y_{ij}}{\sum_{i\in S}\sum_{j\in S_i}w_{ij}}$

In essence, sampling weights in complex survey designs play a crucial role in ensuring that the survey results are both accurate and generalizable to the broader population.














# Conclusion

# References

