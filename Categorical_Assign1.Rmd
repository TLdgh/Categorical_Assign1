---
title: "MAT5317 Categorical Assignment 1"
author: 
  - Teng Li(7373086)
  - Zhize Lu(300075114) 
  - Chutong Zhang(300311325)
output: html_document
header-includes: 
  - \renewcommand{\and}{\\}
  - \usepackage{float}
  - \floatplacement{figure}{H}
bibliography: References.bib
link-citations: yes
---

```{=html}
<style type="text/css">
body{
font-size: 12pt;
}
table{
font-size: 12pt;
}
</style>
```
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
library(plotly)
library(tidyverse)
library(kableExtra)
library(aplore3)
```

## Introduction

We were given the data set of The National Health and Nutrition Examination Survey (NHANES). The survey program has been conducted as a series of surveys designed to assess the health and nutritional status of adults and children in the United States since the 1960s, according to CDC [@CDC]. It combines in-person face-to-face interviews and physical examinations of participants for data collection.

The survey data wasn't a simple random sample, however. According to CDC's National Health and Nutrition Examination Survey: Plan and Operations, 1999--2010 [@SurveyDesign], the sampling strategy consists of several stages: 1. Selection of counties as primary sampling units (PSU). 2. selection of segments within PSUs that constitute blocks of households. 3. Selection of specific households within segments. 4. Selection of individuals within a household.

We aim to study the relationship between the weight variable and the other health related variables of the data.

## Method

We began our study by doing an exploratory analysis among the variables through various tables and charts. We then performed several hypothesis tests on some of the variables. Lastly we did a linear regression model fit to the response variable "weight" with other variables and confounders.

## Part 1: Exploratory Analysis

We began our analysis by giving a data dictionary of the data shown in Table 1 below. As one can see that some variables have a high percentage of missing values. In Part 2 we made hypothesis tests to decide if some of these variables could be excluded from the regression analysis in Part 3.

The weight variable was a continuous random variable in our data. A simple way of categorizing it was to consider the BMI indicator. As one could see there was an obese variable in the data. The weight variable was categorized by giving a threshold of 35 to the BMI value. A person is considered healthy if the BMI is below 35, and obese otherwise. Therefore, we used the obese variable as the categorical random variable in our project.

```{r}
#create data variable definition
DataDict<-data.frame(
  Variables=colnames(nhanes), 
  Type=sapply(nhanes, function(x) class(x)),
  Example=sapply(nhanes, function(x) paste(as.character(head(unique(x),3)), collapse = ", ")),
  Number.Unique=sapply(nhanes, function(x) length(unique(na.omit(x)))),
  MissingPct=sapply(nhanes, function(x) paste0(round(sum(is.na(x))/nrow(nhanes)*100,2), "%")),
  Comment=c("Identification Code (1 - 6482)",
            "Gender (1: Male, 2: Female)",
            "Age (Years)",
            "Marital Status (1: Married, 2: Widowed, 3: Divorced, 4: Separated, 5: Never Married, 6: Living Together)",
            "Statistical Weight (4084.478 - 153810.3)",
            "Pseudo-PSU (1, 2)",
            "Pseudo-Stratum (1 - 15)",
            "Total Cholesterol (mg/dL)",
            "HDL-Cholesterol (mg/dL)",
            "Systolic Blood Pressure (mm Hg)",
            "Diastolic Blood Pressure (mm Hg)",
            "Weight (kg)", 
            "Standing Height (cm)",  
            "Body mass Index (Kg/m^2)",
            "Vigorous Work Activity (1: Yes, 2: No)",
            "Moderate Work Activity (1: Yes, 2: No)",
            "Walk or Bicycle (1: Yes, 2: No)",
            "Vigorous Recreational Activities (1: Yes, 2: No)",
            "Moderate Recreational Activities (1: Yes, 2: No)",
            "Minutes of Sedentary Activity per Week (0 - 840)",
            "BMI>35 (1: No, 2: Yes)")
)

DataDict%>%remove_rownames()%>%kable(caption = "Data Variable Definition")%>%
  kable_styling(bootstrap_options=c("striped","bordered","condensed"),position="float_left")%>%
  row_spec(0,bold=TRUE)
```

According to CDC's classification on bodyweight, we have: BMI\<18.5 as Underweight, BMI between 18.5 and 24.9 as Health, BMI between 25 and 29.9 as Overweight, and BMI\>30 as obesity. We adopted this category and found that there was a slight positive relationship between bodyweight and the total cholesterol level. However, we noticed that there was a negative relationship between the HDL and bodyweight. Because of the fact that Tchol is the sum of HDL and LDL, we can conclude that the obese population has a high level of LDL and a low level HDL.

```{r}
nhanes%>%mutate(CDC_obese=case_when(
  bmi <18.5 ~ "Underweight", 
  bmi>=18.5 & bmi<=24.9 ~ "Healthy",
  bmi>24.9 & bmi<=29.9 ~ "Overweight",
  bmi>29.9  ~ "Obesity"
))%>%transmute(CDC_obese=factor(CDC_obese, levels=c("Underweight", "Healthy", "Overweight", "Obesity")), tchol, hdl)%>%na.omit()%>% group_by(CDC_obese)%>%summarise(Mean_tchol=mean(tchol), Mean_hdl=mean(hdl))%>%gather("Type", "Value",Mean_tchol:Mean_hdl)%>%
  plot_ly(x=~CDC_obese, y=~Value, color = ~Type, type = "scatter", mode="lines", height = 300,width = 400)%>%
  layout(
    title=list(text="Mean Cholesterol level across Categories of Bodyweight",font=list(size=12)),
    yaxis = list(range = c(45, 200),dtick = 50)
  )
```

According to ATPIII [@ATP], we can also categorize the cholesterol level.

## Part 2: Hypothesis Tests

```{r}
IndepTest<-setRefClass(
  "IndepTest",
  fields = list(data="data.frame", variable_x="character", variable_y="character",res="list"),
  methods=list(
    initialize=function(data, variable_x, variable_y){
      #make a contingency table for the variable X and Y
      for(x in variable_x){
        .self$res[[x]]<-data%>%select(all_of(c(x, variable_y)))%>%na.omit()%>%
          group_by(across(everything(), as.factor))%>%tally()%>%spread(key=variable_y, value=n)}
    },
    
    get_pvalue=function(){
      #do the chi-squared test
      pvalues<-map(res, function(x){
        y<-ungroup(x)%>%select(-any_of(group_vars(x)))%>%as.matrix()%>%chisq.test()
        return(y$p.value)
      })
      
      #format it nicely
      pvalues<-pvalues%>%data.frame(row.names = "p-value")%>%
        mutate(across(where(is.numeric), .fns = ~as.character(signif(.,4))))
      
      return(pvalues)}
  )
)
```

We first test the independence between obesity and marital status. We form the following contingency table:

```{r}
test_marstat<-IndepTest$new(nhanes, "marstat", "obese")
test_marstat$res$marstat%>%
  rename("\t" = marstat) %>%
  add_column(" " = c("Marital Status", rep(" ", nrow(.) - 1)), .before = "\t") %>%
  kable(caption = "Contingency Table")%>%
  kable_styling(bootstrap_options=c("striped","condensed"),position="float_left")%>%
  add_header_above(c(" " = 1, " " = 1, "Obesity" = 2))%>%
  column_spec(1:2,width = "10em",bold=TRUE)

pv<-test_marstat$get_pvalue()%>%as.numeric()
```

Let X be the categorical random variable for Marital Status and Y be the one for Obesity. Assuming a random sample of n trials. Define the count random variable $N_{ij}:=\sum_{k=1}^n \mathbf{I}_k(X=i, Y=j)$ where $\mathbf{I}_k$ is the indicator function for the k-th trial, then the joint random variables $[N_{11}, ..., N_{IJ}]$ has a Multinomial distribution $\vec{p}=[p_{11}, ..., p_{IJ}]$. Our hypothesis test is therefore:

```{=tex}
\begin{gather*}
H_0: p_{ij}= p_{i+} \cdot p_{+j} ~ \forall i,j\\
H_1:p_{ij} \neq p_{i+} \cdot p_{+j} ~ \forall i,j
\end{gather*}
```
We use the chi-squared test to conclude that there is not enough evidence to reject the null hypothesis with a p-value equal to `r pv`. In other words, we cannot conclude that there is a relationship between obesity and marital status.

We do the same test for other variables compared with obesity. From Table 2 we can see that we can reject the independence between obesity and wlkbik, vigrecexr and modrecexr variables.

```{r}
tests<-IndepTest$new(nhanes, c("vigwrk","modwrk","wlkbik","vigrecexr","modrecexr"), "obese")
tests$get_pvalue()%>%
  kable(caption = "p-values of Independence Tests between Different Variables and Obesity")%>%
  kable_styling(bootstrap_options=c("striped","condensed"),position="float_left")
```

Based on thresholds established by clinicians, we categorizing four variables related to the cholesterol and blood pressure level. 

Cholesterol is an essential fat in the body. According to American Heart Association, We have: tchol of 240mg/dl or higher OR hdl under 40mg/dL as Dangerous Cholesterol level; tchol between 200-239mg/dL OR hdl between 40-59mg/dL for males OR between 50-59mg/dL for females as at risk level; tchol under 200mg/dL and hdl of 60mg/dL and higher as healthy level.

Blood pressure is typically categorized into different stages based on the systolic (top number) and diastolic (bottom number) readings. According to American Heart Association, We have: systolic level less than 120mm Hg and diastolic level less than 80mm Hg as normal blood pressure; systolic level between 120-129mm Hg and diastolic level less than 80mm Hg as elevated blood pressure; systolic level between 130-139mm Hg OR diastolic level between 80-89mm Hg as Hypertension Stage 1; systolic level 140mm Hg or higher OR diastolic level 90mm Hg or higher as Hypertension Stage 2; systolic level higher than 180mm Hg OR diastolic level higher than 120mm Hg as Hypertensive Crisis.

```{r}

nhanes_data <- nhanes

# Categorizing cholesterol levels
nhanes_data$chol_category <- with(nhanes_data, ifelse(
  tchol >= 240 | hdl < 40, "Dangerous",
  ifelse(
    tchol >= 200 & tchol < 240 | 
    (gender == "Male" & hdl >= 40 & hdl < 60) |  # Male and HDL between 40-59
    (gender == "Female" & hdl >= 50 & hdl < 60),   # Female and HDL between 50-59
    "At Risk",
    "Healthy"
  )
))

# Preview the updated variable
head(nhanes_data[, c("gender","tchol", "hdl", "chol_category")])

# Categorizing blood pressure
nhanes_data$bp_category <- with(nhanes_data, ifelse(
  sysbp < 120 & dbp < 80, "Normal",
  ifelse(sysbp >= 120 & sysbp <= 129 & dbp < 80, "Elevated",
  ifelse((sysbp >= 130 & sysbp <= 139) | (dbp >= 80 & dbp <= 89), "Hypertension Stage 1",
  ifelse(sysbp >= 140 | dbp >= 90, "Hypertension Stage 2",
  ifelse(sysbp > 180 | dbp > 120, "Hypertensive Crisis", NA))))))

# Preview the new variable
head(nhanes_data[, c("sysbp", "dbp", "bp_category")])
```

```{r}
library(knitr)
library(kableExtra)

# Categorize weight based on BMI
nhanes_data$weight_category <- ifelse(nhanes_data$bmi < 35, "Healthy", "Obese")

# Omit rows with any NA values
nhanes_data_clean <- nhanes_data[complete.cases(nhanes_data), ]

# Function to generate detailed statistics for a given variable

generate_detailed_summary <- function(var_name, data) {
  # Remove the "_cat" suffix
  display_var_name <- gsub("_cat", "", var_name)
  
  levels_of_var <- unique(data[[var_name]])
  summaries <- lapply(levels_of_var, function(level) {
    total_count <- sum(data[[var_name]] == level, na.rm = TRUE)
    total_percentage <- (total_count / nrow(data)) * 100
    
    healthy_count <- sum(data[[var_name]][data$weight_category == "Healthy"] == level, na.rm = TRUE)
    healthy_percentage <- (healthy_count / sum(data$weight_category == "Healthy", na.rm = TRUE)) * 100
    
    obese_count <- sum(data[[var_name]][data$weight_category == "Obese"] == level, na.rm = TRUE)
    obese_percentage <- (obese_count / sum(data$weight_category == "Obese", na.rm = TRUE)) * 100
    
    data.frame(
      SampleCharacteristic = as.character(level),
      Total = paste0(total_count, " (", sprintf("%.2f", total_percentage), "%)"),
      Healthy = paste0(healthy_count, " (", sprintf("%.2f", healthy_percentage), "%)"),
      Obese = paste0(obese_count, " (", sprintf("%.2f", obese_percentage), "%)")
    )
  })
  
  # Add the primary heading for the variable, bolded
  primary_heading <- data.frame(SampleCharacteristic = paste0("**", display_var_name, "**"), Total = "", Healthy = "", Obese = "")
  rbind(primary_heading, do.call(rbind, summaries))
}

vars_to_summarize <- c("gender", "marstat", "psu", "vigwrk", "modwrk", "wlkbik", "vigrecexr", "modrecexr", 
                       "tchol_cat", "hdl_cat", "sysbp_cat", "dbp_cat")

summary_table <- do.call(rbind, lapply(vars_to_summarize, generate_detailed_summary, data = nhanes_data_clean))
knitr::kable(summary_table, 
             caption = "Table 1: Descriptive Summary by Weight Category", 
             align = c('l', 'c', 'c', 'c'),
             row.names = FALSE, 
             format.args = list(big.mark = ","),
             col.names = c('Sample Characteristic', 'Total', 'Healthy (BMI < 35)', 'Obese (BMI >= 35)'))

```

##Part 3: Survey weights in complex survey designs Direct sampling of individual elements is often emphasized when working with a list frame that identifies all population elements. However, in large-scale surveys, creating such a list frame can be impractical due to non-availability or prohibitive costs. Additionally, if the population elements are dispersed over a vast area, direct sampling might lead to excessive fieldwork costs. In such instances, cluster sampling becomes a viable alternative.

Most large-scale surveys often involve a combination of multiple sampling design techniques, like cluster sampling and stratification, enable researchers to obtain accurate estimates while catering to practical and cost considerations. A central tenet to these designs is the concept of sampling weights, pivotal in ensuring unbiased estimation.

Sampling weights are best defined as the inverse of the probability that a specific unit gets selected in the sample. These weights adjust for design-imposed inequalities in selection probabilities and compute point estimates.

(Cluster sampling)

(Weight in cluster sampling)

## Conclusion

## References
