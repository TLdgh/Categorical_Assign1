---
title: "MAT5317 Categorical Assignment 1"
author: 
  - Teng Li(7373086)
  - Zhize Lu(300075114) 
  - Chutong Zhang(300311325)
output: html_document
header-includes: 
  - \renewcommand{\and}{\\}
  - \usepackage{float}
  - \floatplacement{figure}{H}
bibliography: References.bib
link-citations: yes
---

<style type="text/css">
body{
font-size: 12pt;
}
table{
font-size: 12pt;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
library(plotly)
library(tidyverse)
library(kableExtra)
library(aplore3)
library(ggplot2)
```

## Introduction
We were given the data set of The National Health and Nutrition Examination Survey (NHANES). The survey program has been conducted as a series of surveys designed to assess the health and nutritional status of adults and children in the United States since the 1960s, according to CDC [@CDC]. It combines in-person face-to-face interviews and physical examinations of participants for data collection. 

The survey data wasn't a simple random sample, however. According to CDC's National Health and Nutrition Examination Survey: Plan and Operations, 1999â€“2010 [@SurveyDesign], the sampling strategy consists of several stages: 1. Selection of counties as primary sampling units (PSU). 2. selection of segments within PSUs that constitute blocks of households. 3. Selection of specific households within segments. 4. Selection of individuals within a household. 

We aim to study the relationship between the weight variable and the other health related variables of the data.

## Method
We began our study by doing an exploratory analysis among the variables through various tables and charts. We then performed several hypothesis tests on some of the variables. Lastly we did a linear regression model fit to the response variable "weight" with other variables and confounders.

## Part 1: Exploratory Analysis
We began our analysis by giving a data dictionary of the data shown in Table 1 below. As one can see that some variables have a high percentage of missing values. In Part 2 we made hypothesis tests to decide if some of these variables could be excluded from the regression analysis in Part 3. 

The weight variable was a continuous random variable in our data. A simple way of categorizing it was to consider the BMI indicator. As one could see there was an obese variable in the data. The weight variable was categorized by giving a threshold of 35 to the BMI value. A person is considered healthy if the BMI is below 35, and obese otherwise. Therefore, we used the obese variable as the categorical random variable in our project. 

From the table 1, we can realized that there are 6445 observations with 21 variables in our data set and 8 variables can be considered as categorical variables. But in original data set, it exists 6482 observations and 37 of them are missing information for variable bmi. We deleted these missing data and use BMI level to stratified observations, since the missing data less than 0.6% in total. 
```{r}
#Table 1 
#install.packages("table1")
library(table1)
Bnhanes<-nhanes
Bnhanes<-mutate(Bnhanes,BMI_level = case_when(
    Bnhanes$bmi < 18.5 ~"Underweight",
    Bnhanes$bmi < 25 ~"Healthy weight",
    Bnhanes$bmi < 30 ~"Overweight",
    Bnhanes$bmi >= 30 ~"Obesity "))%>%
    filter(!is.na(Bnhanes$bmi))
  
label(Bnhanes$gender) <- "Gender"
label(Bnhanes$age)<-"Age"
label(Bnhanes$marstat)<-"Marital Status"
label(Bnhanes$samplewt)<-"Statistical Weight"
label(Bnhanes$psu)<-"Pseudo-PSU"
label(Bnhanes$strata)<-"Pseudo-stratum"
label(Bnhanes$tchol)<-"Total Cholesterol"
label(Bnhanes$hdl)<-"HDL-Cholesterol"
label(Bnhanes$sysbp)<-"Systolic Blood Pressure"
label(Bnhanes$dbp)<-"Diastolic Blood Pressure "
label(Bnhanes$wt)<-"Weight"
label(Bnhanes$ht)<-"Standing Height"
label(Bnhanes$bmi)<-"Body mass Index"
label(Bnhanes$vigwrk)<-"Vigorous Work Activity"
label(Bnhanes$modwrk)<-"Moderate Work Activity "
label(Bnhanes$wlkbik)<-"Walk or Bicycle "
label(Bnhanes$vigrecexr)<-"Vigorous Recreational Activities "
label(Bnhanes$modrecexr)<-"Moderate Recreational Activities"
label(Bnhanes$sedmin)<-"Minutes of Sedentary Activity per Week "
label(Bnhanes$obese)<-"Obese "

units(Bnhanes$age) <- "years"
units(Bnhanes$tchol) <- "mg/dL"
units(Bnhanes$hdl) <- "mg/dL"
units(Bnhanes$sysbp) <- "mm Hg"
units(Bnhanes$dbp) <- "mm Hg"
units(Bnhanes$wt) <- "Kg"
units(Bnhanes$ht) <- "cm"
units(Bnhanes$bmi) <- "Kg/m^2"
units(Bnhanes$sedmin) <- "mins"

tbl<-table1 (~ gender+age+marstat+samplewt+psu+strata+tchol+hdl+sysbp+dbp+wt+ht+vigwrk+modwrk+wlkbik+vigrecexr+modrecexr+sedmin+obese |BMI_level, data=Bnhanes)
kable(tbl,"html",caption="Table 1: Characteristics of the data set NHANES")%>%
 kable_styling(bootstrap_options = "striped", full_width = F)
```

```{r}
#create data variable definition
DataDict<-data.frame(
  Variables=colnames(nhanes), 
  Type=sapply(nhanes, function(x) class(x)),
  Example=sapply(nhanes, function(x) paste(as.character(head(unique(x),3)), collapse = ", ")),
  Number.Unique=sapply(nhanes, function(x) length(unique(na.omit(x)))),
  MissingPct=sapply(nhanes, function(x) paste0(round(sum(is.na(x))/nrow(nhanes)*100,2), "%")),
  Comment=c("Identification Code (1 - 6482)",
            "Gender (1: Male, 2: Female)",
            "Age (Years)",
            "Marital Status (1: Married, 2: Widowed, 3: Divorced, 4: Separated, 5: Never Married, 6: Living Together)",
            "Statistical Weight (4084.478 - 153810.3)",
            "Pseudo-PSU (1, 2)",
            "Pseudo-Stratum (1 - 15)",
            "Total Cholesterol (mg/dL)",
            "HDL-Cholesterol (mg/dL)",
            "Systolic Blood Pressure (mm Hg)",
            "Diastolic Blood Pressure (mm Hg)",
            "Weight (kg)", 
            "Standing Height (cm)",  
            "Body mass Index (Kg/m^2)",
            "Vigorous Work Activity (1: Yes, 2: No)",
            "Moderate Work Activity (1: Yes, 2: No)",
            "Walk or Bicycle (1: Yes, 2: No)",
            "Vigorous Recreational Activities (1: Yes, 2: No)",
            "Moderate Recreational Activities (1: Yes, 2: No)",
            "Minutes of Sedentary Activity per Week (0 - 840)",
            "BMI>35 (1: No, 2: Yes)")
)

DataDict%>%remove_rownames()%>%kable(caption = "Data Variable Definition")%>%
  kable_styling(bootstrap_options=c("striped","bordered","condensed"),position="float_left")%>%
  row_spec(0,bold=TRUE)
```

According to CDC's classification on bodyweight, we have: BMI<18.5 as Underweight, BMI between 18.5 and 24.9 as Health, BMI between 25 and 29.9 as Overweight, and BMI>30 as obesity. We adopted this category and found that there was a slight positive relationship between bodyweight and the total cholesterol level. However, we noticed that there was a negative relationship between the HDL and bodyweight. Because of the fact that Tchol is the sum of HDL and LDL, we can conclude that the obese population has a high level of LDL and a low level HDL.

```{r}
nhanes%>%mutate(CDC_obese=case_when(
  bmi <18.5 ~ "Underweight", 
  bmi>=18.5 & bmi<=24.9 ~ "Healthy",
  bmi>24.9 & bmi<=29.9 ~ "Overweight",
  bmi>29.9  ~ "Obesity"
))%>%transmute(CDC_obese=factor(CDC_obese, levels=c("Underweight", "Healthy", "Overweight", "Obesity")), tchol, hdl)%>%na.omit()%>% group_by(CDC_obese)%>%summarise(Mean_tchol=mean(tchol), Mean_hdl=mean(hdl))%>%gather("Type", "Value",Mean_tchol:Mean_hdl)%>%
  plot_ly(x=~CDC_obese, y=~Value, color = ~Type, type = "scatter", mode="lines", height = 300,width = 400)%>%
  layout(
    title=list(text="Mean Cholesterol level across Categories of Bodyweight",font=list(size=12)),
    yaxis = list(range = c(45, 200),dtick = 50)
  )
```

According to ATPIII [@ATP], we can also categorize the cholesterol level.

This data set mainly focus on the observers between 16 to 80 years old. Among them, the average weight for male is greater than female among all ages, and as we can see from the line chart that the change in average weight with age follow the same trend across the gender, with a general tendency to sustained increase, followed by fluctuation and continuous decrease finally. It can be considered as there might exist some relationship with weight and age.
```{r}
#exploratory average weight in every age grouped by gender
gender<-nhanes%>%
  group_by(gender,age)%>%
  summarise(Avgwt=mean(wt,na.rm=TRUE))
   ggplot(gender,aes(x=age, y=Avgwt), group=gender)+
     geom_point(aes(colour=gender),size=1 )+
     geom_line(aes(fill=gender,colour=gender,linetype=gender) )+
     geom_hline(yintercept = 86.2, linetype="dotted", size = 0.5)+
     geom_hline(yintercept = 74.9, linetype="dotted", size = 0.5)+
     annotate("text", y=86.2, x=18, label=" Male Avg.")+
     annotate("text", y=74.9, x=18, label="Female Avg.")+
      scale_y_continuous( labels = scales::comma  ) +
    theme(axis.text.x = element_text(size =7, vjust = 0.5, hjust = 0.5, angle = 45))+
   
   labs(title="Average Weight in Different Age",x="Age", y="Average weight (Kg)")+
   theme(plot.title = element_text(hjust = 0.5))
```

For the observations in different marital status, we also interested in the relationship between weight and marital status.The following box plot shows that the median weight under different marital status are all around 80 Kg, widowed observation have lowest weight among six categories. Married and Never Married observations have more people heavier than 130 Kg than other categories, which may not good for health.
```{r}
#box plot for weight VS marital status
Nhanes<-nhanes%>%
  na.omit()
ggplot(Nhanes, aes(x=marstat, y=wt, fill=marstat))+
        geom_boxplot() + 
        scale_fill_brewer(palette="Blues") +
        labs(title = "Plot for weight in each marital status", x="Marital Status", y="Weight (Kg)")+
        theme(axis.text.x = element_text(size =7, vjust = 0.5, hjust = 0.5, angle = 45),
              plot.title = element_text(hjust = 0.5)
       )
```

Different types of work and recreational activities also are interesting variables to discuss.We can see that only 1 missing data in these four variables,so we omit this missing data directly. For the vigorous activities, observations not in both work and recreational activities got the lowest and highest BMI. No matter the condition on work activities, upper quartile for observations are below 30 and lower quartile greater than 20 in observations have vigorous recreational activities. This means that majority people in this condition have a healthy BMI index. For moderate activities, observation not in both moderate work and recreational activities have the highest BMI and observation only in moderate work activities have the lowest BMI. No matter the condition on work activities, upper quartile for observations are slightly above 30 and lower quartile greater than 20 in observations have vigorous recreational activities. In general, we can see from two plots that observations have vigorous or moderate recreational activities trend to have healthy BMI index than others,and under same recreational activities condition observations in moderate or vigorous work activities have less number of observations have high BMI index. Hence, different types of work or recreational activities may have relationship with weight and affect BMI index in this way.
```{r} 
#boxplot for Vigorous activities VS bmi
Nhanes<-nhanes%>%
   mutate(vigrecexr = case_when(
    (nhanes$vigrecexr %in% "Yes") ~ "Vigorous Recreational Activities",
    (nhanes$vigrecexr %in% "No") ~ "Not Vigorous Recreational Activities"))%>%
   na.omit()
   ggplot(Nhanes, aes(x=vigwrk, y=bmi, fill=vigwrk))+
        geom_boxplot() + 
        facet_wrap(~vigrecexr) +
      geom_hline(yintercept = 18.5, linetype="dotted", size = 0.5)+
      geom_hline(yintercept = 30, linetype="dotted", size = 0.5)+
      annotate("text", y=18.5, x="Yes", label=" underweight")+
      annotate("text", y=30,x="Yes", label=" obsity")+
        scale_fill_brewer(palette="Blues") +
        labs(title = "Plot for BMI in Vigorous Activities", x=" Vigorous Work Activity", y="BMI")+
        theme(axis.text.x = element_text(size =7, vjust = 0.5, hjust = 0.5, angle = 45),
              plot.title = element_text(hjust = 0.5)
       )
  
  #boxplot for Moderate activities VS weight
Nhanes<-nhanes%>%
  mutate(modrecexr = case_when(
    (nhanes$modrecexr %in% "Yes") ~ "Moderate Recreational Activities",
    (nhanes$modrecexr %in% "No") ~ "Not Moderate Recreational Activities"))%>%
  na.omit()
  ggplot(Nhanes, aes(x=modwrk, y=bmi, fill=modwrk))+
        geom_boxplot() + 
       facet_wrap(~modrecexr) +
        scale_fill_brewer(palette="Blues") +
    geom_hline(yintercept = 18.5, linetype="dotted", size = 0.5)+
      geom_hline(yintercept = 30, linetype="dotted", size = 0.5)+
      annotate("text", y=18.5, x="Yes", label=" underweight")+
      annotate("text", y=30,x="Yes", label=" obsity")+
        labs(title = "Plot for BMI in Moderate Activities", x=" Moderate Work Activity", y="BMI")+
        theme(axis.text.x = element_text(size =7, vjust = 0.5, hjust = 0.5, angle = 45),
              plot.title = element_text(hjust = 0.5)
       )
```

## Part 2: Hypothesis Tests

```{r}
IndepTest<-setRefClass(
  "IndepTest",
  fields = list(data="data.frame", variable_x="character", variable_y="character",res="list"),
  methods=list(
    initialize=function(data, variable_x, variable_y){
      #make a contingency table for the variable X and Y
      for(x in variable_x){
        .self$res[[x]]<-data%>%select(all_of(c(x, variable_y)))%>%na.omit()%>%
          group_by(across(everything(), as.factor))%>%tally()%>%spread(key=variable_y, value=n)}
    },
    
    get_pvalue=function(){
      #do the chi-squared test
      pvalues<-map(res, function(x){
        y<-ungroup(x)%>%select(-any_of(group_vars(x)))%>%as.matrix()%>%chisq.test()
        return(y$p.value)
      })
      
      #format it nicely
      pvalues<-pvalues%>%data.frame(row.names = "p-value")%>%
        mutate(across(where(is.numeric), .fns = ~as.character(signif(.,4))))
      
      return(pvalues)}
  )
)
```

We first test the independence between obesity and marital status. We form the following contingency table:
```{r}
test_marstat<-IndepTest$new(nhanes, "marstat", "obese")
test_marstat$res$marstat%>%
  rename("\t" = marstat) %>%
  add_column(" " = c("Marital Status", rep(" ", nrow(.) - 1)), .before = "\t") %>%
  kable(caption = "Contingency Table")%>%
  kable_styling(bootstrap_options=c("striped","condensed"),position="float_left")%>%
  add_header_above(c(" " = 1, " " = 1, "Obesity" = 2))%>%
  column_spec(1:2,width = "10em",bold=TRUE)

pv<-test_marstat$get_pvalue()%>%as.numeric()
```

Let X be the categorical random variable for Marital Status and Y be the one for Obesity. Assuming a random sample of n trials. Define the count random variable $N_{ij}:=\sum_{k=1}^n \mathbf{I}_k(X=i, Y=j)$ where $\mathbf{I}_k$ is the indicator function for the k-th trial, then the joint random variables $[N_{11}, ..., N_{IJ}]$ has a Multinomial distribution $\vec{p}=[p_{11}, ..., p_{IJ}]$. Our hypothesis test is therefore:

\begin{gather*}
H_0: p_{ij}= p_{i+} \cdot p_{+j} ~ \forall i,j\\
H_1:p_{ij} \neq p_{i+} \cdot p_{+j} ~ \forall i,j
\end{gather*}

We use the chi-squared test to conclude that there is not enough evidence to reject the null hypothesis with a p-value equal to `r pv`. In other words, we cannot conclude that there is a relationship between obesity and marital status.

We do the same test for other variables compared with obesity. From Table 2 we can see that we can reject the independence between obesity and wlkbik, vigrecexr and modrecexr variables.

```{r}
tests<-IndepTest$new(nhanes, c("vigwrk","modwrk","wlkbik","vigrecexr","modrecexr"), "obese")
tests$get_pvalue()%>%
  kable(caption = "p-values of Independence Tests between Different Variables and Obesity")%>%
  kable_styling(bootstrap_options=c("striped","condensed"),position="float_left")
```















# Conclusion

# References

